<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceLink | Persistent Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        :root {
            --color-gold: #c9a96e;
            --color-tan: #bfa181;
            --color-bg: #f8f5f0;
            --color-dark: #2e2e2e;
            --color-gray: #7d7d7d;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-dark);
        }

        .visualizer-container {
            height: 48px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .bar {
            flex: 1;
            background: var(--color-gold);
            min-height: 2px;
            border-radius: 1px;
            transition: height 0.1s ease;
        }
        .remote-bar { background: var(--color-tan); }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.98); }
        }
        .anim-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        .custom-ring:focus {
            ring-color: var(--color-gold);
            border-color: var(--color-gold);
        }
    </style>
</head>
<body class="min-h-screen font-sans flex items-center justify-center p-4">

    <div class="max-w-sm w-full bg-white rounded-[2.5rem] shadow-2xl border border-[#bfa181]/20 overflow-hidden">
        <!-- Header -->
        <div class="p-8 pb-4 text-center">
            <h1 class="text-3xl font-black text-[#2e2e2e] tracking-tight">VoiceLink</h1>
            <p class="text-[#7d7d7d] text-sm font-medium mt-1">Persistent Audio Room</p>
        </div>

        <!-- Visualizers -->
        <div class="px-8 py-4 flex items-center justify-around bg-[#f8f5f0] border-y border-[#bfa181]/20">
            <div class="text-center">
                <p class="text-[9px] font-black text-[#7d7d7d] uppercase tracking-widest mb-2">Your Mic</p>
                <div id="localVisualizer" class="visualizer-container w-24 px-1"></div>
            </div>
            <div class="h-10 w-px bg-[#bfa181]/30"></div>
            <div class="text-center">
                <p class="text-[9px] font-black text-[#7d7d7d] uppercase tracking-widest mb-2">Room Audio</p>
                <div id="remoteVisualizer" class="visualizer-container w-24 px-1"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-8 space-y-6">
            <!-- Connection State -->
            <div id="statusContainer" class="text-center">
                <span id="statusBadge" class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest bg-[#f8f5f0] text-[#7d7d7d]">
                    Not in Room
                </span>
            </div>

            <!-- Setup View -->
            <div id="setupView" class="space-y-6">
                <div class="space-y-3">
                    <p class="text-[10px] font-bold text-[#7d7d7d] uppercase tracking-widest text-center">Choose Room Name</p>
                    <input type="text" id="roomInput" class="w-full p-4 bg-[#f8f5f0] border border-[#bfa181]/30 rounded-2xl text-center text-lg font-mono font-bold text-[#2e2e2e] focus:ring-4 focus:ring-[#c9a96e]/10 focus:border-[#c9a96e] outline-none transition-all" placeholder="e.g. coffee-chat">
                    <p class="text-[10px] text-center text-[#7d7d7d]">Parties with the same Room Name connect automatically.</p>
                </div>

                <button id="btnJoin" class="w-full bg-[#c9a96e] hover:bg-[#bfa181] text-white font-bold py-4 rounded-2xl transition shadow-lg flex items-center justify-center gap-2 group">
                    <i data-lucide="door-open" class="w-5 h-5 group-hover:translate-x-1 transition"></i>
                    Enter Room
                </button>
            </div>

            <!-- Active View -->
            <div id="activeView" class="hidden space-y-6">
                <div class="p-4 bg-[#f8f5f0] border border-[#bfa181]/30 rounded-2xl text-center">
                    <p class="text-[10px] font-bold text-[#bfa181] uppercase tracking-widest mb-1">Active Room</p>
                    <p id="displayRoomName" class="text-lg font-mono font-bold text-[#2e2e2e]">----</p>
                </div>

                <div id="liveIndicator" class="flex items-center justify-center gap-2 text-[#7d7d7d] font-bold text-sm">
                    <span id="statusDot" class="w-2 h-2 rounded-full bg-slate-300"></span>
                    <span id="roomStatusText">Searching...</span>
                </div>

                <button id="btnLeave" class="w-full bg-[#f8f5f0] text-[#2e2e2e] hover:bg-red-50 hover:text-red-600 border border-[#bfa181]/30 font-bold py-4 rounded-2xl transition flex items-center justify-center gap-2">
                    <i data-lucide="log-out" class="w-5 h-5"></i> Leave Room
                </button>
            </div>
        </div>

        <div class="px-8 pb-8 text-center">
            <p class="text-[9px] font-bold text-[#7d7d7d] uppercase tracking-widest tracking-widest">Automatic P2P Handshake</p>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>

    <script>
        window.addEventListener('load', function() {
            const refreshIcons = () => { if (window.lucide) window.lucide.createIcons(); };
            refreshIcons();

            const statusBadge = document.getElementById('statusBadge');
            const roomInput = document.getElementById('roomInput');
            const displayRoomName = document.getElementById('displayRoomName');
            const setupView = document.getElementById('setupView');
            const activeView = document.getElementById('activeView');
            const remoteAudio = document.getElementById('remoteAudio');
            const statusDot = document.getElementById('statusDot');
            const roomStatusText = document.getElementById('roomStatusText');

            let peer = null;
            let localStream = null;
            let currentCall = null;
            let roomName = "";
            let role = ""; // 'A' or 'B'
            let connectionCheckInterval = null;

            async function getMedia() {
                if (localStream) return localStream;
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    visualize(localStream, 'localVisualizer');
                    return localStream;
                } catch (err) {
                    alert("Mic access needed to join the voice room.");
                    throw err;
                }
            }

            function updateUI(connected) {
                if (connected) {
                    statusDot.className = "w-2 h-2 rounded-full bg-[#c9a96e] anim-pulse";
                    roomStatusText.innerText = "Voice Live";
                    roomStatusText.className = "text-[#c9a96e] font-bold text-sm";
                } else {
                    statusDot.className = "w-2 h-2 rounded-full bg-slate-300";
                    roomStatusText.innerText = "Waiting for peer...";
                    roomStatusText.className = "text-[#7d7d7d] font-bold text-sm";
                }
            }

            async function tryConnect(targetId) {
                if (currentCall || !peer || peer.destroyed) return;
                try {
                    const stream = await getMedia();
                    const call = peer.call(targetId, stream);
                    if (call) handleCall(call);
                } catch (e) {
                    console.error("Call attempt failed:", e);
                }
            }

            function handleCall(call) {
                if (currentCall) currentCall.close();
                currentCall = call;
                updateUI(true);

                call.on('stream', (stream) => {
                    remoteAudio.srcObject = stream;
                    visualize(stream, 'remoteVisualizer');
                });

                const onDisconnect = () => {
                    if (currentCall === call) {
                        currentCall = null;
                        updateUI(false);
                        const bars = document.querySelectorAll('#remoteVisualizer .bar');
                        bars.forEach(b => b.style.height = '2px');
                    }
                };

                call.on('close', onDisconnect);
                call.on('error', onDisconnect);
            }

            function setupPeerListeners() {
                peer.on('call', async (call) => {
                    try {
                        const stream = await getMedia();
                        call.answer(stream);
                        handleCall(call);
                    } catch (e) {
                        console.error("Failed to answer call:", e);
                    }
                });

                peer.on('disconnected', () => {
                    if (peer && !peer.destroyed) peer.reconnect();
                });
            }

            async function initializePeer(suffix) {
                if (peer) {
                    peer.destroy();
                }

                const id = `${roomName}-${suffix}`;
                peer = new Peer(id);

                return new Promise((resolve) => {
                    peer.on('open', (id) => {
                        role = suffix.toUpperCase();
                        statusBadge.innerText = `Room Active (${role})`;
                        setupPeerListeners();
                        updateUI(false);
                        
                        if (role === 'B') {
                            // User B initiates the connection to User A
                            tryConnect(`${roomName}-a`);
                        }
                        resolve(true);
                    });

                    peer.on('error', (err) => {
                        if (err.type === 'id-taken' && suffix === 'a') {
                            // Slot A is taken, try Slot B
                            resolve(initializePeer('b'));
                        } else {
                            console.error("PeerJS Error:", err);
                            if (err.type === 'id-taken') {
                                alert("This room is currently full (2/2 users).");
                                location.reload();
                            }
                            resolve(false);
                        }
                    });
                });
            }

            document.getElementById('btnJoin').onclick = async () => {
                roomName = roomInput.value.trim().toLowerCase();
                if (!roomName) return;

                setupView.classList.add('hidden');
                activeView.classList.remove('hidden');
                displayRoomName.innerText = roomName;
                statusBadge.innerText = "Connecting...";

                const success = await initializePeer('a');
                
                if (success) {
                    // Periodic check to ensure Slot B is trying to talk to Slot A
                    connectionCheckInterval = setInterval(() => {
                        if (!currentCall && peer && !peer.destroyed && role === "B") {
                            tryConnect(`${roomName}-a`);
                        }
                    }, 5000);
                }
            };

            document.getElementById('btnLeave').onclick = () => {
                if (connectionCheckInterval) clearInterval(connectionCheckInterval);
                if (peer) peer.destroy();
                location.reload();
            };

            // Visualizer Code
            function createBars(container) {
                for (let i = 0; i < 15; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar' + (container.id === 'remoteVisualizer' ? ' remote-bar' : '');
                    container.appendChild(bar);
                }
            }
            createBars(document.getElementById('localVisualizer'));
            createBars(document.getElementById('remoteVisualizer'));

            async function visualize(stream, containerId) {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    if (ctx.state === 'suspended') await ctx.resume();
                    const source = ctx.createMediaStreamSource(stream);
                    const analyser = ctx.createAnalyser();
                    analyser.fftSize = 64;
                    source.connect(analyser);
                    const data = new Uint8Array(analyser.frequencyBinCount);
                    const bars = document.querySelectorAll(`#${containerId} .bar`);
                    const update = () => {
                        if (!ctx || ctx.state === 'closed') return;
                        analyser.getByteFrequencyData(data);
                        for (let i = 0; i < bars.length; i++) {
                            if (bars[i]) {
                                bars[i].style.height = `${Math.max(2, (data[i] / 255) * 40)}px`;
                            }
                        }
                        requestAnimationFrame(update);
                    };
                    update();
                } catch (e) {}
            }
        });
    </script>
</body>
</html>
