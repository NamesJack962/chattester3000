<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceLink | 6-Digit Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <style>
        .visualizer-container {
            height: 48px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .bar {
            flex: 1;
            background: #3b82f6;
            min-height: 2px;
            border-radius: 1px;
            transition: height 0.1s ease;
        }
        .remote-bar { background: #10b981; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .anim-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans flex items-center justify-center p-4">

    <div class="max-w-sm w-full bg-white rounded-[2.5rem] shadow-2xl border border-slate-200 overflow-hidden">
        <!-- Header -->
        <div class="p-8 pb-4 text-center">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-600 text-white rounded-3xl mb-4 shadow-xl shadow-blue-100">
                <i data-lucide="mic-2" class="w-8 h-8"></i>
            </div>
            <h1 class="text-2xl font-black text-slate-800 tracking-tight">VoiceLink</h1>
            <p class="text-slate-400 text-sm font-medium">Ultra-short code pairing</p>
        </div>

        <!-- Connection Indicators -->
        <div class="px-8 py-4 flex items-center justify-around bg-slate-50/50 border-y border-slate-100">
            <div class="text-center">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">You</p>
                <div id="localVisualizer" class="visualizer-container w-24 px-1"></div>
            </div>
            <div class="h-10 w-px bg-slate-200"></div>
            <div class="text-center">
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-2">Peer</p>
                <div id="remoteVisualizer" class="visualizer-container w-24 px-1"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="p-8 space-y-6">
            <div id="setupView" class="space-y-6">
                <div id="hostSection" class="space-y-4">
                    <button id="btnCreateRoom" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl transition shadow-lg shadow-blue-200 flex items-center justify-center gap-2">
                        <i data-lucide="radio" class="w-5 h-5"></i> Host a Call
                    </button>
                    
                    <div id="codeDisplay" class="hidden space-y-2 text-center p-4 bg-blue-50 border border-blue-100 rounded-2xl">
                        <p class="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Your 6-Digit Code</p>
                        <div class="text-3xl font-mono font-black text-blue-700 tracking-[0.5em] pl-[0.25em]" id="txtRoomCode">------</div>
                        <p class="text-[10px] text-blue-500 font-medium anim-pulse">Waiting for peer to join...</p>
                    </div>
                </div>

                <div class="relative">
                    <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-100"></span></div>
                    <div class="relative flex justify-center text-xs uppercase font-bold text-slate-300"><span class="bg-white px-2">or</span></div>
                </div>

                <div id="joinSection" class="space-y-3">
                    <input type="text" id="inputJoinCode" maxlength="6" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-center text-xl font-mono font-bold tracking-[0.3em] focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all uppercase" placeholder="000000">
                    <button id="btnJoinRoom" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl transition shadow-lg">
                        Join with Code
                    </button>
                </div>
            </div>

            <div id="activeView" class="hidden text-center space-y-6">
                <div class="flex items-center justify-center gap-2 text-emerald-500 font-bold text-sm">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 anim-pulse"></span>
                    Encrypted P2P Active
                </div>
                <button onclick="location.reload()" class="w-full bg-red-50 text-red-500 hover:bg-red-100 font-bold py-4 rounded-2xl transition flex items-center justify-center gap-2">
                    <i data-lucide="phone-off" class="w-5 h-5"></i> End Call
                </button>
            </div>
        </div>

        <div class="px-8 pb-8 text-center">
            <p id="statusLabel" class="text-[10px] font-bold text-slate-300 uppercase tracking-widest">Ready to Connect</p>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'v-p2p-short';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let pc = null;
        let localStream = null;
        let user = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        // UI Selectors
        const setupView = document.getElementById('setupView');
        const activeView = document.getElementById('activeView');
        const statusLabel = document.getElementById('statusLabel');
        const txtRoomCode = document.getElementById('txtRoomCode');
        const codeDisplay = document.getElementById('codeDisplay');
        const inputJoinCode = document.getElementById('inputJoinCode');
        const remoteAudio = document.getElementById('remoteAudio');

        // Logic: Auth (MANDATORY RULE 3)
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, u => { user = u; });

        window.onload = () => {
            initAuth();
            if (typeof lucide !== 'undefined') lucide.createIcons();
            createBars(document.getElementById('localVisualizer'));
            createBars(document.getElementById('remoteVisualizer'));
        };

        // UI: Visualizers
        function createBars(container) {
            for (let i = 0; i < 15; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar' + (container.id === 'remoteVisualizer' ? ' remote-bar' : '');
                container.appendChild(bar);
            }
        }

        async function visualize(stream, containerId) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') await ctx.resume();
            const source = ctx.createMediaStreamSource(stream);
            const analyser = ctx.createAnalyser();
            analyser.fftSize = 64;
            source.connect(analyser);
            const data = new Uint8Array(analyser.frequencyBinCount);
            const bars = document.querySelectorAll(`#${containerId} .bar`);
            const update = () => {
                analyser.getByteFrequencyData(data);
                for (let i = 0; i < bars.length; i++) {
                    bars[i].style.height = `${Math.max(2, (data[i] / 255) * 40)}px`;
                }
                requestAnimationFrame(update);
            };
            update();
        }

        // Logic: WebRTC
        async function initPC() {
            pc = new RTCPeerConnection(rtcConfig);
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            visualize(localStream, 'localVisualizer');

            pc.ontrack = e => {
                remoteAudio.srcObject = e.streams[0];
                visualize(e.streams[0], 'remoteVisualizer');
            };

            pc.oniceconnectionstatechange = () => {
                statusLabel.innerText = pc.iceConnectionState;
                if (pc.iceConnectionState === 'connected') {
                    setupView.classList.add('hidden');
                    activeView.classList.remove('hidden');
                }
            };
        }

        function getRoomDoc(code) {
            // RULE 1: Specific path
            return doc(db, 'artifacts', appId, 'public', 'data', 'calls', code.trim().toUpperCase());
        }

        // Logic: Host
        document.getElementById('btnCreateRoom').onclick = async () => {
            if (!user) return;
            const code = Math.random().toString(36).substring(2, 8).toUpperCase();
            txtRoomCode.innerText = code;
            codeDisplay.classList.remove('hidden');
            document.getElementById('btnCreateRoom').classList.add('hidden');
            
            await initPC();
            const roomRef = getRoomDoc(code);

            pc.onicecandidate = async e => {
                if (e.candidate) await updateDoc(roomRef, { hostCandidates: arrayUnion(e.candidate.toJSON()) });
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            await setDoc(roomRef, {
                offer: { type: offer.type, sdp: offer.sdp },
                hostCandidates: [],
                peerCandidates: []
            });

            onSnapshot(roomRef, async snap => {
                const data = snap.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                }
                if (data?.peerCandidates) {
                    data.peerCandidates.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)).catch(() => {}));
                }
            });
        };

        // Logic: Join
        document.getElementById('btnJoinRoom').onclick = async () => {
            if (!user) return;
            const code = inputJoinCode.value.toUpperCase();
            if (code.length < 6) return alert("Enter 6-digit code");

            statusLabel.innerText = "Finding room...";
            const roomRef = getRoomDoc(code);
            const snap = await getDoc(roomRef);
            
            if (!snap.exists()) return alert("Room not found!");

            await initPC();

            pc.onicecandidate = async e => {
                if (e.candidate) await updateDoc(roomRef, { peerCandidates: arrayUnion(e.candidate.toJSON()) });
            };

            onSnapshot(roomRef, async s => {
                const data = s.data();
                if (!pc.currentRemoteDescription && data?.offer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await updateDoc(roomRef, { answer: { type: answer.type, sdp: answer.sdp } });
                }
                if (data?.hostCandidates) {
                    data.hostCandidates.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c)).catch(() => {}));
                }
            });
        };
    </script>
</body>
</html>

