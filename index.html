<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Whispers - Lofi Voice Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');
        
        :root {
            --woods-moss: #4A5D4E;
            --woods-bark: #3E362E;
            --woods-fog: #E8EBE4;
            --woods-paper: #FDFBF7;
            --woods-leaf: #A3B18A;
            --woods-clay: #D4A373;
            --woods-shadow: rgba(62, 54, 46, 0.08);
        }

        body { 
            font-family: 'Quicksand', sans-serif; 
            background-color: var(--woods-fog); 
            color: var(--woods-bark);
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        h1, h2, h3, .serif { font-family: 'Lora', serif; }

        .lofi-btn-primary {
            height: 48px;
            padding: 0 24px;
            border-radius: 24px;
            background-color: var(--woods-moss);
            color: var(--woods-paper);
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 0px #354238;
        }
        .lofi-btn-primary:hover { transform: translateY(2px); box-shadow: 0 2px 0px #354238; }

        .lofi-card {
            background-color: var(--woods-paper);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(74, 93, 78, 0.15);
            box-shadow: 0 8px 24px var(--woods-shadow);
        }

        .lofi-input {
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--woods-leaf);
            border-radius: 18px;
            padding: 12px 20px;
            width: 100%;
        }

        .chat-sidebar { width: 340px; background: var(--woods-paper); border-left: 1px solid rgba(74, 93, 78, 0.1); display: flex; flex-direction: column; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { max-width: 90%; padding: 0.75rem 1rem; border-radius: 18px; font-size: 0.875rem; }
        .message-received { background: var(--woods-fog); align-self: flex-start; }
        .message-sent { background: var(--woods-moss); color: white; align-self: flex-end; }
        
        .channel-item { border-bottom: 1px solid rgba(0,0,0,0.03); transition: all 0.2s ease; cursor: pointer; }
        .active-room-bg { background: rgba(74, 93, 78, 0.06); border-left: 4px solid var(--woods-moss); }

        .ear-btn {
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; color: var(--woods-bark); opacity: 0.3;
        }
        .ear-btn.listening { opacity: 1; color: var(--woods-clay); background: rgba(212, 163, 115, 0.1); }

        .ripple { position: absolute; border: 2px solid var(--woods-leaf); border-radius: 50%; pointer-events: none; opacity: 0; }
        .speaking .ripple { animation: ripple-effect 1.5s infinite ease-out; }
        @keyframes ripple-effect { 0% { transform: scale(0.8); opacity: 0.5; } 100% { transform: scale(2); opacity: 0; } }

        .yt-hidden { position: absolute; left: -10000px; width: 1px; height: 1px; opacity: 0; }
        
        /* Volume Slider Custom Styling */
        .vol-container {
            position: relative;
            width: 120px;
            height: 24px;
            display: flex;
            align-items: center;
        }

        input[type=range].vol-slider {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            z-index: 10;
        }

        input[type=range].vol-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(74, 93, 78, 0.1);
            border-radius: 2px;
        }

        input[type=range].vol-slider::-webkit-slider-thumb {
            height: 14px;
            width: 6px;
            border-radius: 2px;
            background: var(--woods-moss);
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -5px;
            box-shadow: 0 0 4px rgba(0,0,0,0.1);
        }

        .vol-scale-line {
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: repeating-linear-gradient(to right, #4A5D4E 0, #4A5D4E 1px, transparent 1px, transparent 20%);
            opacity: 0.15;
            pointer-events: none;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <main id="app-container" class="flex-1 flex overflow-hidden">
        
        <!-- Setup Views -->
        <div id="setup-view" class="absolute inset-0 z-[60] flex flex-col items-center justify-center p-8 bg-[--woods-fog]">
            <div class="w-full max-w-xl space-y-12">
                <div class="text-center space-y-4">
                    <h2 class="text-5xl font-bold text-[--woods-bark] serif">Forest Whispers</h2>
                    <p class="opacity-60 text-lg">Gather with friends in the digital undergrowth.</p>
                </div>
                <div class="space-y-6 w-full px-10 py-12 bg-[--woods-paper] rounded-[40px] border border-[rgba(74,93,78,0.1)] shadow-2xl">
                    <input id="setup-username-input" type="text" placeholder="What should we call you?" class="lofi-input text-xl text-center mb-6">
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="handleHost()" class="lofi-btn-primary">Start a Grove</button>
                        <button onclick="showJoinInput()" class="lofi-btn-primary !bg-white !text-[--woods-moss] !border-2 !border-[--woods-moss] !shadow-none">Join a Path</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="join-view" class="hidden absolute inset-0 z-[60] flex flex-col items-center justify-center p-8 bg-[--woods-fog]">
            <div class="w-full max-w-md space-y-10 text-center">
                <h3 class="text-3xl font-bold serif">Which path are you following?</h3>
                <input id="join-room-id" type="text" placeholder="CODE" class="w-full bg-transparent border-b-2 border-[--woods-moss] p-4 text-center text-5xl font-bold uppercase focus:outline-none">
                <div class="flex flex-col gap-4">
                    <button onclick="handleJoin()" class="lofi-btn-primary w-full text-lg">Enter Grove</button>
                    <button onclick="showSetup()" class="text-sm font-bold opacity-40 uppercase tracking-widest">Turn Back</button>
                </div>
            </div>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="hidden w-full h-full flex overflow-hidden">
            <!-- Sidebar -->
            <aside class="w-80 bg-[--woods-paper] border-r border-[rgba(74,93,78,0.1)] flex flex-col z-20 h-full">
                <div class="h-24 flex items-center justify-between px-8 border-b border-[rgba(74,93,78,0.05)]">
                    <h3 class="text-[11px] font-bold text-[--woods-moss] uppercase tracking-[0.25em]">Clearings</h3>
                    <button onclick="toggleRoomModal()" class="w-8 h-8 rounded-full bg-[--woods-fog] flex items-center justify-center text-[--woods-moss] hover:scale-110">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                <div id="subroom-list" class="flex-1 overflow-y-auto"></div>
                <div class="p-8 border-t border-[rgba(74,93,78,0.05)]">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-[--woods-moss] text-white flex items-center justify-center font-bold text-lg" id="local-avatar-char">?</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold truncate text-sm" id="local-name-display">Wanderer</div>
                            <div class="text-[10px] opacity-40 font-bold uppercase tracking-wider">Present</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Area -->
            <div class="flex-1 flex flex-col bg-white/40">
                <header class="h-24 px-8 flex items-center justify-between border-b border-[rgba(74,93,78,0.1)] bg-[--woods-paper]/90 backdrop-blur-xl">
                    <div class="flex flex-col">
                        <h1 class="text-xl font-bold text-[--woods-moss] serif">Forest Whispers</h1>
                        <span id="room-id-display" class="text-[10px] font-bold opacity-30 tracking-[0.3em] uppercase">----</span>
                    </div>
                    
                    <!-- Ambient Echoes Personal Controls -->
                    <div class="flex items-center gap-4 bg-[--woods-paper] px-4 py-2 rounded-2xl border border-[--woods-leaf]/20 shadow-sm">
                        <div class="flex flex-col items-start min-w-[100px]">
                            <span class="text-[9px] font-bold opacity-40 uppercase tracking-tighter">Ambient Echoes</span>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleMusicModal()" id="now-playing-title" class="text-[10px] font-bold text-[--woods-moss] truncate max-w-[90px] hover:underline">Silent Grove</button>
                                <div id="playback-status-dot" class="w-1.5 h-1.5 rounded-full bg-gray-300"></div>
                            </div>
                        </div>
                        
                        <!-- Global Controls -->
                        <div class="flex items-center gap-1 border-l border-[--woods-bark]/10 pl-3">
                            <button onclick="ytAction('prev')" class="p-1 hover:text-[--woods-moss] opacity-60"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                            <button onclick="ytAction('toggle')" id="personal-play-pause" class="p-1.5 bg-[--woods-fog] rounded-full hover:scale-105 transition-transform"><svg id="play-pause-icon" width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                            <button onclick="ytAction('next')" class="p-1 hover:text-[--woods-moss] opacity-60"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                        </div>

                        <!-- Volume Interface (Enhanced) -->
                        <div class="flex flex-col items-center gap-0.5 border-l border-[--woods-bark]/10 pl-4">
                            <div class="vol-container">
                                <div class="vol-scale-line"></div>
                                <input type="range" id="local-vol-slider" min="0" max="100" value="40" oninput="updateLocalVolume(this.value)" class="vol-slider">
                            </div>
                            <div class="flex justify-between w-full px-1 text-[8px] font-bold opacity-30 uppercase tracking-[0.1em]">
                                <span>0%</span>
                                <span id="vol-percent-display">40%</span>
                                <span>100</span>
                            </div>
                        </div>
                    </div>

                    <button onclick="copyRoomId()" class="w-10 h-10 rounded-full bg-[--woods-fog] flex items-center justify-center text-[--woods-moss] hover:bg-white border border-[--woods-leaf]/10">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
                    </button>
                </header>

                <div class="flex-1 overflow-y-auto p-12">
                    <div class="max-w-4xl mx-auto space-y-12">
                        <div class="flex items-end justify-between border-b-2 border-[--woods-moss]/10 pb-6">
                            <div>
                                <h2 class="text-4xl font-bold text-[--woods-moss] serif" id="current-room-label">Primary Clearing</h2>
                            </div>
                            <span id="peer-count-badge" class="px-4 py-1.5 rounded-full bg-[--woods-leaf] text-white text-[10px] font-bold">1 SPIRIT</span>
                        </div>
                        <div id="peer-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                    </div>
                </div>

                <footer class="h-28 bg-[--woods-paper] border-t border-[rgba(74,93,78,0.1)] px-12 flex items-center justify-between">
                    <div class="flex items-center gap-6">
                        <button id="mute-btn" onclick="toggleMute()" class="w-14 h-14 rounded-full bg-[--woods-fog] border-2 border-[--woods-leaf] flex items-center justify-center text-[--woods-moss] shadow-lg">
                            <svg id="mic-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path></svg>
                        </button>
                        <canvas id="visualizer-canvas" class="w-40 h-10 opacity-30"></canvas>
                    </div>
                    <button onclick="location.reload()" class="lofi-btn-primary !bg-red-50 !text-red-900 !border-red-100 !shadow-none">Depart</button>
                </footer>
            </div>

            <aside class="chat-sidebar">
                <div id="chat-messages"></div>
                <div class="p-6">
                    <input id="chat-input" type="text" placeholder="Whisper..." class="lofi-input !text-sm" onkeydown="if(event.key==='Enter') sendChatMessage()">
                </div>
            </aside>
        </div>
    </main>

    <div id="youtube-anchor" class="yt-hidden"></div>
    
    <!-- Music & Queue Modal -->
    <div id="music-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-[--woods-bark]/40 backdrop-blur-md">
        <div class="bg-[--woods-paper] rounded-[40px] w-full max-w-md p-10 space-y-6 shadow-2xl max-h-[90vh] flex flex-col">
            <h3 class="text-2xl font-bold text-center serif">Atmosphere Queue</h3>
            
            <div class="space-y-2">
                <label class="text-[10px] font-bold opacity-40 uppercase">Add to Queue</label>
                <div class="flex gap-2">
                    <input id="yt-link-input" type="text" placeholder="YouTube Link..." class="lofi-input">
                    <button onclick="addToQueue()" class="lofi-btn-primary !px-4">Add</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto space-y-4 py-2 border-y border-[--woods-bark]/5">
                <div id="music-queue-list" class="space-y-2">
                    <p class="text-center py-8 opacity-30 text-sm">The silence is peaceful...</p>
                </div>
            </div>

            <div class="pt-2 flex flex-col gap-3">
                <button onclick="skipToNext()" class="lofi-btn-primary w-full !bg-[--woods-clay] !shadow-[#b58b62]">Skip Current Song</button>
                <button onclick="toggleMusicModal()" class="w-full text-xs font-bold opacity-40 uppercase py-2">Return to Forest</button>
            </div>
        </div>
    </div>
    
    <div id="room-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-[--woods-bark]/40 backdrop-blur-md">
        <div class="bg-[--woods-paper] rounded-[40px] w-full max-w-sm p-10 space-y-6 shadow-2xl">
            <h3 class="text-2xl font-bold text-center serif">New Clearing</h3>
            <input id="subroom-name-input" type="text" placeholder="Name..." class="lofi-input">
            <button onclick="confirmCreateSubRoom()" class="lofi-btn-primary w-full">Create</button>
            <button onclick="toggleRoomModal()" class="w-full text-xs font-bold opacity-40 uppercase">Cancel</button>
        </div>
    </div>

    <script>
        const PREFS_KEY = 'forest_whispers_v11';
        let prefs = { username: '', listeningRooms: ['main'], volume: 40 };
        let peer = null, localStream = null, isMuted = false;
        let remotePeers = {}, currentSubRoom = 'main', subRooms = { 'main': 'Primary Clearing' }, connections = {};
        
        // Music State
        let ytPlayer = null;
        let musicQueue = [];
        let currentTrack = null;

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-anchor', {
                height: '0', width: '0', videoId: '',
                playerVars: { 'autoplay': 1, 'controls': 0, 'disablekb': 1 },
                events: { 
                    'onReady': (e) => {
                        e.target.setVolume(prefs.volume);
                    },
                    'onStateChange': (e) => {
                        if (e.data === YT.PlayerState.ENDED) skipToNext();
                        updatePlaybackUI(e.data);
                    }
                }
            });
        }

        function updatePlaybackUI(state) {
            const icon = document.getElementById('play-pause-icon');
            const dot = document.getElementById('playback-status-dot');
            if (state === YT.PlayerState.PLAYING) {
                icon.innerHTML = `<path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>`;
                dot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-[0_0_5px_rgba(16,185,129,0.5)]";
            } else {
                icon.innerHTML = `<path d="M8 5v14l11-7z"/>`;
                dot.className = "w-1.5 h-1.5 rounded-full bg-gray-300";
            }
        }

        function loadPreferences() {
            const saved = localStorage.getItem(PREFS_KEY);
            if (saved) prefs = JSON.parse(saved);
            document.getElementById('setup-username-input').value = prefs.username || '';
            const vol = prefs.volume || 40;
            document.getElementById('local-vol-slider').value = vol;
            document.getElementById('vol-percent-display').innerText = vol + '%';
        }

        async function requestMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupVisualizer(localStream);
            } catch (err) { console.error("Media fail", err); }
            return localStream;
        }

        function toggleMusicModal() { document.getElementById('music-modal').classList.toggle('hidden'); renderQueueUI(); }
        function toggleRoomModal() { document.getElementById('room-modal').classList.toggle('hidden'); }

        function updateLocalVolume(val) {
            prefs.volume = val;
            document.getElementById('vol-percent-display').innerText = val + '%';
            if (ytPlayer && ytPlayer.setVolume) ytPlayer.setVolume(val);
            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
        }

        function ytAction(action) {
            if (!ytPlayer) return;
            switch(action) {
                case 'toggle':
                    const state = ytPlayer.getPlayerState();
                    state === YT.PlayerState.PLAYING ? ytPlayer.pauseVideo() : ytPlayer.playVideo();
                    break;
                case 'next': skipToNext(); break;
                case 'prev': ytPlayer.seekTo(0); break;
            }
        }

        function showJoinInput() {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('join-view').classList.remove('hidden');
        }

        function showSetup() {
            document.getElementById('setup-view').classList.remove('hidden');
            document.getElementById('join-view').classList.add('hidden');
        }

        function updateUsernamePref() {
            const input = document.getElementById('setup-username-input');
            prefs.username = input.value.trim() || 'Spirit_' + Math.floor(Math.random()*999);
            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
            return prefs.username;
        }

        function enterLobby(username) {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('join-view').classList.add('hidden');
            document.getElementById('lobby-view').classList.remove('hidden');
            document.getElementById('local-avatar-char').innerText = username[0].toUpperCase();
            document.getElementById('local-name-display').innerText = username;
            renderSubRooms();
        }

        async function handleHost() {
            const name = updateUsernamePref();
            await requestMedia();
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            initPeer(id);
            createPeerCard('local', name);
            enterLobby(name);
        }

        async function handleJoin() {
            const target = document.getElementById('join-room-id').value.toUpperCase().trim();
            if (!target) return;
            const name = updateUsernamePref();
            await requestMedia();
            initPeer();
            peer.on('open', () => {
                const conn = peer.connect(target);
                setupConn(conn);
                peer.call(target, localStream);
                createPeerCard('local', name);
                enterLobby(name);
            });
        }

        function initPeer(id = null) {
            peer = id ? new Peer(id) : new Peer();
            peer.on('open', (newId) => document.getElementById('room-id-display').innerText = peer.id.toUpperCase());
            peer.on('connection', setupConn);
            peer.on('call', (call) => {
                call.answer(localStream);
                call.on('stream', (stream) => handleStream(call.peer, stream));
            });
        }

        function setupConn(conn) {
            conn.on('open', () => { 
                connections[conn.peer] = conn; 
                broadcastSync(); 
            });
            conn.on('data', (data) => {
                if (data.type === 'sync') {
                    Object.assign(subRooms, data.subRooms);
                    musicQueue = data.musicQueue || musicQueue;
                    if (data.currentTrack && (!currentTrack || data.currentTrack.id !== currentTrack.id)) syncTrack(data.currentTrack);
                    if (remotePeers[conn.peer]) {
                        remotePeers[conn.peer].currentSubRoom = data.userRoom;
                        remotePeers[conn.peer].username = data.username;
                    }
                    renderSubRooms(); updateVisibility(); renderQueueUI();
                } else if (data.type === 'chat') {
                    addChat(data.username, data.text, false);
                } else if (data.type === 'music_update') {
                    musicQueue = data.musicQueue;
                    if (data.newTrack) syncTrack(data.newTrack);
                    renderQueueUI();
                }
            });
            conn.on('close', () => {
                if(remotePeers[conn.peer]) {
                    if (remotePeers[conn.peer].element) remotePeers[conn.peer].element.remove();
                    delete remotePeers[conn.peer];
                }
                delete connections[conn.peer];
                renderSubRooms(); updateVisibility();
            });
        }

        function syncTrack(track) {
            currentTrack = track;
            document.getElementById('now-playing-title').innerText = track.title;
            if (ytPlayer && ytPlayer.loadVideoById) ytPlayer.loadVideoById(track.id);
        }

        function broadcastSync() {
            Object.values(connections).forEach(c => c.send({ 
                type: 'sync', subRooms, userRoom: currentSubRoom, username: prefs.username, musicQueue, currentTrack
            }));
        }

        function broadcastMusic() {
            Object.values(connections).forEach(c => c.send({ type: 'music_update', musicQueue, newTrack: currentTrack }));
        }

        function addToQueue() {
            const link = document.getElementById('yt-link-input').value;
            const match = link.match(/[?&]v=([^&#]+)/) || link.match(/youtu\.be\/([^?&#]+)/);
            if (match) {
                const vid = match[1];
                const track = { id: vid, title: "Echo (" + vid.substring(0,4) + ")" };
                if (!currentTrack) { currentTrack = track; syncTrack(track); }
                else { musicQueue.push(track); }
                document.getElementById('yt-link-input').value = '';
                broadcastMusic(); renderQueueUI();
            }
        }

        function skipToNext() {
            if (musicQueue.length > 0) { currentTrack = musicQueue.shift(); syncTrack(currentTrack); }
            else { currentTrack = null; document.getElementById('now-playing-title').innerText = "Silent Grove"; if (ytPlayer) ytPlayer.stopVideo(); }
            broadcastMusic(); renderQueueUI();
        }

        function renderQueueUI() {
            const list = document.getElementById('music-queue-list');
            if (!list) return;
            if (!currentTrack && musicQueue.length === 0) {
                list.innerHTML = `<p class="text-center py-8 opacity-30 text-sm">The silence is peaceful...</p>`;
                return;
            }
            let html = '';
            if (currentTrack) {
                html += `<div class="p-4 rounded-2xl bg-[--woods-moss] text-white flex flex-col gap-1 border-2 border-[--woods-moss]"><span class="text-[9px] font-bold uppercase tracking-widest opacity-60">Now Resonating</span><span class="font-bold truncate text-sm">${currentTrack.title}</span></div>`;
            }
            musicQueue.forEach((track, idx) => {
                html += `<div class="p-4 rounded-2xl bg-white border border-[--woods-bark]/5 flex items-center justify-between group"><div class="flex flex-col gap-1 overflow-hidden"><span class="text-[9px] font-bold uppercase tracking-widest opacity-40">Next in Path</span><span class="font-bold truncate text-sm">${track.title}</span></div><button onclick="removeFromQueue(${idx})" class="opacity-0 group-hover:opacity-100 p-2 text-red-400 hover:text-red-600"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>`;
            });
            list.innerHTML = html;
        }

        function removeFromQueue(idx) { musicQueue.splice(idx, 1); broadcastMusic(); renderQueueUI(); }

        function renderSubRooms() {
            const list = document.getElementById('subroom-list');
            list.innerHTML = '';
            Object.keys(subRooms).forEach(roomId => {
                const isPresent = currentSubRoom === roomId;
                const isListening = prefs.listeningRooms.includes(roomId);
                const div = document.createElement('div');
                div.className = `channel-item px-6 py-4 flex items-center justify-between gap-4 ${isPresent ? 'active-room-bg' : ''}`;
                div.innerHTML = `<div class="flex-1 min-w-0" onclick="switchRoom('${roomId}')"><div class="text-sm font-bold truncate ${isPresent ? 'text-[--woods-moss]' : 'opacity-60'}">${subRooms[roomId]}</div><div class="text-[9px] font-bold uppercase tracking-widest opacity-30">${isPresent ? 'My Path' : (isListening ? 'Eavesdropping' : 'Distant')}</div></div>${!isPresent ? `<button onclick="event.stopPropagation(); toggleListening('${roomId}')" class="ear-btn ${isListening ? 'listening' : ''}"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 13a6 6 0 1 0 12 0"/><path d="M21 13c0-4.97-4.03-9-9-9s-9 4.03-9 9"/><path d="M12 11v4"/></svg></button>` : `<div class="w-8 h-8 flex items-center justify-center text-[--woods-moss]"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg></div>`}`;
                list.appendChild(div);
            });
        }

        function toggleListening(id) {
            if (currentSubRoom === id) return;
            prefs.listeningRooms = prefs.listeningRooms.includes(id) ? prefs.listeningRooms.filter(r => r !== id) : [...prefs.listeningRooms, id];
            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
            updateVisibility(); renderSubRooms();
        }

        function switchRoom(id) {
            if (currentSubRoom === id) return;
            currentSubRoom = id;
            if (!prefs.listeningRooms.includes(id)) prefs.listeningRooms.push(id);
            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
            document.getElementById('current-room-label').innerText = subRooms[id];
            updateVisibility(); renderSubRooms(); broadcastSync();
        }

        function handleStream(id, stream) {
            if (!remotePeers[id]) {
                const audio = new Audio(); audio.srcObject = stream; audio.play();
                const name = `Spirit_${id.substring(0,3)}`;
                const card = createPeerCard(id, name);
                remotePeers[id] = { stream, element: card, audio, currentSubRoom: 'main', username: name };
                updateVisibility(); broadcastSync();
            }
        }

        function updateVisibility() {
            let visible = 0;
            Object.keys(remotePeers).forEach(id => {
                const p = remotePeers[id];
                const audible = prefs.listeningRooms.includes(p.currentSubRoom);
                const show = p.currentSubRoom === currentSubRoom;
                if (p.element) p.element.style.display = show ? 'block' : 'none';
                if (p.audio) p.audio.muted = !audible;
                if (show) visible++;
            });
            document.getElementById('peer-count-badge').innerText = `${visible + 1} SPIRIT${(visible + 1) !== 1 ? 'S' : ''}`;
        }

        function createPeerCard(id, name) {
            const grid = document.getElementById('peer-grid');
            let div = document.getElementById(`peer-${id}`);
            if (!div) { div = document.createElement('div'); div.id = `peer-${id}`; grid.appendChild(div); }
            div.className = `lofi-card relative overflow-hidden`;
            div.innerHTML = `<div class="ripple"></div><div class="flex items-center gap-4 relative z-10"><div class="w-14 h-14 rounded-2xl bg-[--woods-fog] flex items-center justify-center font-bold text-xl text-[--woods-moss]">${name[0].toUpperCase()}</div><div><div class="font-bold">${name}</div><div class="text-[10px] opacity-40 uppercase font-bold tracking-widest">Presence</div></div></div>`;
            return div;
        }

        function setupVisualizer(stream) {
            const canvas = document.getElementById('visualizer-canvas');
            const ctx = canvas.getContext('2d');
            const actx = new (window.AudioContext || window.webkitAudioContext)();
            const an = actx.createAnalyser();
            actx.createMediaStreamSource(stream).connect(an);
            const data = new Uint8Array(an.frequencyBinCount);
            function draw() {
                requestAnimationFrame(draw); an.getByteFrequencyData(data);
                ctx.clearRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = '#A3B18A';
                for(let i=0; i<60; i++) { const h = (data[i]/255)*canvas.height; ctx.fillRect(i*3, canvas.height-h, 2, h); }
            }
            draw();
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (localStream) localStream.getAudioTracks()[0].enabled = !isMuted;
            const btn = document.getElementById('mute-btn');
            btn.classList.toggle('!bg-red-800', isMuted);
            btn.classList.toggle('!text-white', isMuted);
            document.getElementById('mic-icon').innerHTML = isMuted ? `<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path>` : `<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>`;
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim(); if (!text) return;
            addChat('You', text, true);
            Object.values(connections).forEach(c => c.send({ type: 'chat', username: prefs.username, text }));
            input.value = '';
        }

        function addChat(user, text, isMe) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'message-sent' : 'message-received'}`;
            div.innerHTML = `<div class="text-[10px] opacity-50 mb-1">${user}</div><div>${text}</div>`;
            container.appendChild(div); container.scrollTop = container.scrollHeight;
        }

        function confirmCreateSubRoom() {
            const name = document.getElementById('subroom-name-input').value.trim(); if (!name) return;
            const id = 'r-' + Math.random().toString(36).substring(2, 6);
            subRooms[id] = name; switchRoom(id); toggleRoomModal();
        }

        function copyRoomId() {
            const id = document.getElementById('room-id-display').innerText;
            if (id !== "----") navigator.clipboard.writeText(id);
        }

        window.onload = loadPreferences;
    </script>
</body>
</html>
