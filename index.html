import React, { useState, useEffect, useRef, useMemo } from 'react';
import { 
  Mic, MicOff, Settings, PhoneOff, User, 
  Copy, Check, Volume2, Keyboard, Play 
} from 'lucide-react';
import Peer from 'peerjs';

// --- Components ---

const VolumeMeter = ({ stream, isMuted }) => {
  const [volume, setVolume] = useState(0);
  const audioCtx = useRef(null);
  const analyser = useRef(null);
  const animationRef = useRef(null);

  useEffect(() => {
    if (!stream || isMuted) {
      setVolume(0);
      return;
    }

    try {
      audioCtx.current = new (window.AudioContext || window.webkitAudioContext)();
      analyser.current = audioCtx.current.createAnalyser();
      const source = audioCtx.current.createMediaStreamSource(stream);
      source.connect(analyser.current);
      analyser.current.fftSize = 256;

      const bufferLength = analyser.current.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);

      const updateVolume = () => {
        analyser.current.getByteFrequencyData(dataArray);
        let sum = 0;
        for (let i = 0; i < bufferLength; i++) {
          sum += dataArray[i];
        }
        const average = sum / bufferLength;
        setVolume(average);
        animationRef.current = requestAnimationFrame(updateVolume);
      };

      updateVolume();
    } catch (e) {
      console.error("Audio analysis error", e);
    }

    return () => {
      if (animationRef.current) cancelAnimationFrame(animationRef.current);
      if (audioCtx.current) audioCtx.current.close();
    };
  }, [stream, isMuted]);

  return (
    <div className="w-full h-1 bg-gray-800 rounded-full mt-2 overflow-hidden">
      <div 
        className={`h-full transition-all duration-75 ${volume > 30 ? 'bg-indigo-500 shadow-[0_0_8px_rgba(79,70,229,0.8)]' : 'bg-gray-600'}`}
        style={{ width: `${Math.min(volume * 1.5, 100)}%` }}
      />
    </div>
  );
};

const RemoteAudio = ({ stream }) => {
  const audioRef = useRef(null);
  useEffect(() => {
    if (audioRef.current && stream) {
      audioRef.current.srcObject = stream;
    }
  }, [stream]);

  return <audio ref={audioRef} autoPlay />;
};

export default function App() {
  // --- State ---
  const [view, setView] = useState('setup'); // setup, lobby
  const [username, setUsername] = useState(localStorage.getItem('p2p_username') || '');
  const [roomId, setRoomId] = useState('');
  const [peerId, setPeerId] = useState('');
  const [peers, setPeers] = useState({}); // { id: { stream, name, isMuted } }
  const [isMuted, setIsMuted] = useState(false);
  const [isDeafened, setIsDeafened] = useState(false);
  const [localStream, setLocalStream] = useState(null);
  const [isSettingsOpen, setIsSettingsOpen] = useState(false);
  const [inputMode, setInputMode] = useState('open'); // open, ptt
  const [pttKey, setPttKey] = useState('Space');
  const [isPttActive, setIsPttActive] = useState(false);
  const [copyFeedback, setCopyFeedback] = useState(false);

  // --- Refs ---
  const peerRef = useRef(null);
  const connectionsRef = useRef({});

  // --- Initialization ---
  useEffect(() => {
    localStorage.setItem('p2p_username', username);
  }, [username]);

  // Handle PTT Key Events
  useEffect(() => {
    if (inputMode !== 'ptt') return;

    const handleKeyDown = (e) => {
      if (e.code === pttKey) {
        setIsPttActive(true);
        if (localStream) localStream.getAudioTracks()[0].enabled = true;
      }
    };

    const handleKeyUp = (e) => {
      if (e.code === pttKey) {
        setIsPttActive(false);
        if (localStream) localStream.getAudioTracks()[0].enabled = false;
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    window.addEventListener('keyup', handleKeyUp);
    return () => {
      window.removeEventListener('keydown', handleKeyDown);
      window.removeEventListener('keyup', handleKeyUp);
    };
  }, [inputMode, pttKey, localStream]);

  const startStream = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        } 
      });
      
      // If PTT, start muted
      if (inputMode === 'ptt') {
        stream.getAudioTracks()[0].enabled = false;
      }
      
      setLocalStream(stream);
      return stream;
    } catch (err) {
      console.error("Failed to get local stream", err);
      return null;
    }
  };

  const initPeer = (id) => {
    const peer = new Peer(id, {
      debug: 1
    });

    peer.on('open', (id) => {
      setPeerId(id);
      console.log('My peer ID is: ' + id);
    });

    // When someone calls us
    peer.on('call', async (call) => {
      const stream = localStream || await startStream();
      call.answer(stream);
      call.on('stream', (remoteStream) => {
        addPeer(call.peer, remoteStream);
      });
    });

    peerRef.current = peer;
  };

  const addPeer = (id, stream) => {
    setPeers(prev => ({
      ...prev,
      [id]: { stream, name: `User ${id.substring(0, 4)}`, isMuted: false }
    }));
  };

  const handleHost = async () => {
    if (!username) return;
    const stream = await startStream();
    if (!stream) return;
    
    const id = Math.random().toString(36).substring(2, 8).toUpperCase();
    setRoomId(id);
    initPeer(id);
    setView('lobby');
  };

  const handleJoin = async () => {
    if (!username || !roomId) return;
    const stream = await startStream();
    if (!stream) return;

    initPeer(); // Random ID for joiner
    
    // Wait for peer to open then call host
    const connectToHost = () => {
      const call = peerRef.current.call(roomId, stream);
      call.on('stream', (remoteStream) => {
        addPeer(roomId, remoteStream);
      });
    };

    if (peerRef.current?.open) {
      connectToHost();
    } else {
      peerRef.current?.on('open', connectToHost);
    }

    setView('lobby');
  };

  const toggleMute = () => {
    if (localStream) {
      const newState = !isMuted;
      localStream.getAudioTracks()[0].enabled = !newState;
      setIsMuted(newState);
    }
  };

  const copyRoomId = () => {
    navigator.clipboard.writeText(roomId);
    setCopyFeedback(true);
    setTimeout(() => setCopyFeedback(false), 2000);
  };

  return (
    <div className="min-h-screen bg-[#0F1115] text-gray-100 flex flex-col font-sans selection:bg-indigo-500/30">
      
      {/* Header */}
      <header className="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0F1115]/80 backdrop-blur-md sticky top-0 z-10">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-emerald-500 animate-pulse" />
          <h1 className="font-bold tracking-tight text-lg">P2P VOICE</h1>
        </div>
        {view === 'lobby' && (
          <div className="flex items-center gap-4">
            <button 
              onClick={copyRoomId}
              className="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-md text-sm transition-colors border border-gray-700"
            >
              {copyFeedback ? <Check size={14} className="text-emerald-400" /> : <Copy size={14} />}
              <span className="font-mono">{roomId}</span>
            </button>
          </div>
        )}
      </header>

      {/* Main Content */}
      <main className="flex-1 flex flex-col items-center justify-center p-6 max-w-4xl mx-auto w-full">
        
        {view === 'setup' && (
          <div className="w-full max-w-sm space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="text-center">
              <h2 className="text-3xl font-bold mb-2">Welcome</h2>
              <p className="text-gray-400 text-sm">Ultra-lightweight peer-to-peer voice</p>
            </div>

            <div className="space-y-4">
              <div className="space-y-2">
                <label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Your Identity</label>
                <input 
                  type="text" 
                  placeholder="Username" 
                  value={username}
                  onChange={(e) => setUsername(e.target.value)}
                  className="w-full bg-[#1A1D23] border border-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all"
                />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <button 
                  onClick={handleHost}
                  disabled={!username}
                  className="flex flex-col items-center justify-center gap-3 p-6 bg-[#1A1D23] border border-gray-800 rounded-xl hover:border-indigo-500 hover:bg-indigo-500/5 transition-all group disabled:opacity-50"
                >
                  <Play className="text-indigo-400 group-hover:scale-110 transition-transform" />
                  <span className="font-semibold">Host Room</span>
                </button>
                <button 
                  onClick={() => setView('join_input')}
                  disabled={!username}
                  className="flex flex-col items-center justify-center gap-3 p-6 bg-[#1A1D23] border border-gray-800 rounded-xl hover:border-emerald-500 hover:bg-emerald-500/5 transition-all group disabled:opacity-50"
                >
                  <User className="text-emerald-400 group-hover:scale-110 transition-transform" />
                  <span className="font-semibold">Join Room</span>
                </button>
              </div>
            </div>
          </div>
        )}

        {view === 'join_input' && (
          <div className="w-full max-w-sm space-y-6 animate-in fade-in zoom-in-95">
             <div className="space-y-2">
                <label className="text-xs font-semibold text-gray-500 uppercase tracking-wider">Room ID</label>
                <input 
                  type="text" 
                  placeholder="Paste Room ID" 
                  value={roomId}
                  onChange={(e) => setRoomId(e.target.value.toUpperCase())}
                  className="w-full bg-[#1A1D23] border border-gray-800 rounded-lg p-4 font-mono text-xl text-center tracking-widest focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all"
                />
              </div>
              <div className="flex gap-3">
                <button onClick={() => setView('setup')} className="flex-1 p-3 rounded-lg border border-gray-800 hover:bg-gray-800 transition-colors">Back</button>
                <button 
                  onClick={handleJoin}
                  className="flex-2 bg-emerald-600 hover:bg-emerald-500 px-8 py-3 rounded-lg font-bold transition-colors"
                >
                  Connect
                </button>
              </div>
          </div>
        )}

        {view === 'lobby' && (
          <div className="w-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 animate-in fade-in slide-in-from-bottom-8">
            {/* Local Peer */}
            <div className={`p-4 rounded-2xl border bg-[#1A1D23] transition-all duration-300 ${isPttActive || (!isMuted && inputMode === 'open') ? 'border-indigo-500/50 shadow-[0_0_20px_rgba(79,70,229,0.1)]' : 'border-gray-800'}`}>
              <div className="flex items-center gap-3 mb-2">
                <div className="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold border border-indigo-500/30">
                  {username[0]?.toUpperCase() || 'U'}
                </div>
                <div>
                  <div className="font-bold flex items-center gap-2">
                    {username} <span className="text-[10px] bg-indigo-500/20 text-indigo-400 px-1.5 py-0.5 rounded">YOU</span>
                  </div>
                  <div className="text-xs text-gray-500 uppercase tracking-tighter">
                    {inputMode === 'ptt' ? 'Push-To-Talk' : 'Open Mic'}
                  </div>
                </div>
              </div>
              <VolumeMeter stream={localStream} isMuted={isMuted || (inputMode === 'ptt' && !isPttActive)} />
            </div>

            {/* Remote Peers */}
            {Object.entries(peers).map(([id, peer]) => (
              <div key={id} className="p-4 rounded-2xl border border-gray-800 bg-[#1A1D23]">
                <div className="flex items-center gap-3 mb-2">
                  <div className="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 font-bold border border-emerald-500/30">
                    {peer.name[0]}
                  </div>
                  <div>
                    <div className="font-bold">{peer.name}</div>
                    <div className="text-xs text-gray-500 tracking-tighter uppercase flex items-center gap-1">
                      <Volume2 size={10}/> Connected
                    </div>
                  </div>
                </div>
                <RemoteAudio stream={peer.stream} />
                <VolumeMeter stream={peer.stream} isMuted={false} />
              </div>
            ))}

            {Object.keys(peers).length === 0 && (
              <div className="col-span-full py-12 text-center text-gray-600 border-2 border-dashed border-gray-800 rounded-3xl">
                <p>Waiting for others to join...</p>
              </div>
            )}
          </div>
        )}
      </main>

      {/* Control Bar */}
      {view === 'lobby' && (
        <footer className="p-6 bg-[#0F1115] border-t border-gray-800 sticky bottom-0 flex justify-center items-center gap-4">
          <div className="flex items-center gap-2 bg-[#1A1D23] p-1.5 rounded-2xl border border-gray-800 shadow-xl">
            <button 
              onClick={toggleMute}
              className={`p-4 rounded-xl transition-all ${isMuted ? 'bg-rose-500/20 text-rose-500 border border-rose-500/50' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'}`}
            >
              {isMuted ? <MicOff size={24} /> : <Mic size={24} />}
            </button>
            <button 
              onClick={() => setIsDeafened(!isDeafened)}
              className={`p-4 rounded-xl transition-all ${isDeafened ? 'bg-amber-500/20 text-amber-500 border border-amber-500/50' : 'bg-gray-800 hover:bg-gray-700 text-gray-300'}`}
            >
              <Volume2 size={24} className={isDeafened ? 'opacity-30' : ''} />
            </button>
            <div className="w-px h-8 bg-gray-800 mx-2" />
            <button 
              onClick={() => setIsSettingsOpen(true)}
              className="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-300 transition-all"
            >
              <Settings size={24} />
            </button>
            <button 
              onClick={() => window.location.reload()}
              className="p-4 rounded-xl bg-rose-500 hover:bg-rose-600 text-white transition-all shadow-lg shadow-rose-500/20"
            >
              <PhoneOff size={24} />
            </button>
          </div>
        </footer>
      )}

      {/* Settings Modal */}
      {isSettingsOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
          <div className="bg-[#1A1D23] border border-gray-800 rounded-3xl w-full max-w-md shadow-2xl p-8 space-y-6">
            <div className="flex justify-between items-center">
              <h3 className="text-xl font-bold">Audio Settings</h3>
              <button onClick={() => setIsSettingsOpen(false)} className="text-gray-500 hover:text-white">âœ•</button>
            </div>

            <div className="space-y-6">
              <div className="space-y-3">
                <label className="text-sm font-medium text-gray-400">Input Mode</label>
                <div className="grid grid-cols-2 gap-2 bg-[#0F1115] p-1 rounded-xl">
                  <button 
                    onClick={() => setInputMode('open')}
                    className={`p-2 rounded-lg text-sm transition-all ${inputMode === 'open' ? 'bg-indigo-600 text-white' : 'hover:bg-gray-800 text-gray-500'}`}
                  >
                    Open Mic
                  </button>
                  <button 
                    onClick={() => setInputMode('ptt')}
                    className={`p-2 rounded-lg text-sm transition-all ${inputMode === 'ptt' ? 'bg-indigo-600 text-white' : 'hover:bg-gray-800 text-gray-500'}`}
                  >
                    Push-to-Talk
                  </button>
                </div>
              </div>

              {inputMode === 'ptt' && (
                <div className="space-y-2 animate-in slide-in-from-top-2">
                  <label className="text-sm font-medium text-gray-400 flex items-center gap-2">
                    <Keyboard size={14} /> PTT Keybind
                  </label>
                  <button 
                    className="w-full bg-[#0F1115] border border-gray-800 p-4 rounded-xl text-indigo-400 font-mono text-lg hover:border-indigo-500 transition-colors"
                    onClick={() => {
                      const listener = (e) => {
                        e.preventDefault();
                        setPttKey(e.code);
                        window.removeEventListener('keydown', listener);
                      };
                      window.addEventListener('keydown', listener);
                    }}
                  >
                    {pttKey}
                  </button>
                  <p className="text-[10px] text-center text-gray-600 uppercase">Click to rebind</p>
                </div>
              )}

              <div className="pt-4 border-t border-gray-800">
                <button 
                  onClick={() => setIsSettingsOpen(false)}
                  className="w-full bg-indigo-600 hover:bg-indigo-500 p-3 rounded-xl font-bold transition-all"
                >
                  Save Changes
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

