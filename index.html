<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Voice Chat | WebRTC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <style>
        .visualizer-container {
            height: 60px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .bar {
            flex: 1;
            background: #3b82f6;
            min-height: 4px;
            border-radius: 2px;
            transition: height 0.05s ease;
        }
        .remote-bar { background: #10b981; }
        
        /* Smooth transitions for tabs */
        .tab-content {
            transition: opacity 0.2s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <div class="max-w-3xl mx-auto px-4 py-12">
        <!-- Header -->
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center p-4 bg-blue-600 text-white rounded-3xl shadow-lg shadow-blue-200 mb-6">
                <i data-lucide="mic" class="w-8 h-8"></i>
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight text-slate-900">P2P Voice Chat</h1>
            <p class="text-slate-500 mt-3 text-lg">Secure, serverless audio via WebRTC</p>
        </header>

        <!-- Main Interface -->
        <div class="grid gap-6">
            
            <!-- Connection Status Card -->
            <div id="statusCard" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="signal" class="w-5 h-5 text-blue-500"></i> Connection
                    </h2>
                    <span id="connState" class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-500 uppercase tracking-widest">Disconnected</span>
                </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Local Audio -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">You</span>
                            <i data-lucide="user" class="w-4 h-4 text-slate-300"></i>
                        </div>
                        <div id="localVisualizer" class="visualizer-container bg-slate-50 rounded-2xl p-4 border border-slate-100">
                            <!-- Bars injected by JS -->
                        </div>
                    </div>
                    <!-- Remote Audio -->
                    <div class="space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Peer</span>
                            <i data-lucide="users" class="w-4 h-4 text-slate-300"></i>
                        </div>
                        <div id="remoteVisualizer" class="visualizer-container bg-slate-50 rounded-2xl p-4 border border-slate-100">
                            <!-- Bars injected by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Signaling Controls -->
            <div class="bg-white overflow-hidden rounded-3xl shadow-sm border border-slate-200">
                <div class="flex bg-slate-50/50 p-1 border-b border-slate-200">
                    <button id="tabCaller" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm transition-all duration-200 bg-white shadow-sm text-blue-600">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i> Host Call
                    </button>
                    <button id="tabReceiver" class="flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm transition-all duration-200 text-slate-500 hover:bg-white/50">
                        <i data-lucide="log-in" class="w-4 h-4"></i> Join Call
                    </button>
                </div>

                <div class="p-8">
                    <!-- Host View -->
                    <div id="hostSection" class="space-y-6 tab-content">
                        <div class="space-y-3">
                            <h3 class="font-bold text-slate-800">1. Start the Session</h3>
                            <p class="text-sm text-slate-500">Create an invitation code to share with your peer.</p>
                            <button id="btnCreateOffer" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-2xl transition-all shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                                <i data-lucide="zap" class="w-5 h-5"></i> Generate Offer Code
                            </button>
                        </div>

                        <div class="space-y-3">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Your Offer Code</label>
                            <div class="relative">
                                <textarea id="localSdp" readonly class="w-full h-28 p-4 bg-slate-50 border border-slate-200 rounded-2xl text-[10px] font-mono leading-relaxed focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="The code will appear here..."></textarea>
                                <button id="btnCopyOffer" class="absolute bottom-3 right-3 bg-white border border-slate-200 p-2 rounded-xl hover:bg-slate-50 transition shadow-sm">
                                    <i data-lucide="copy" class="w-4 h-4 text-slate-600"></i>
                                </button>
                            </div>
                        </div>

                        <div class="pt-6 border-t border-slate-100 space-y-4">
                            <h3 class="font-bold text-slate-800">2. Complete Connection</h3>
                            <p class="text-sm text-slate-500">Paste the answer code you received from your peer below.</p>
                            <textarea id="remoteAnswerInput" class="w-full h-28 p-4 border border-slate-200 rounded-2xl text-[10px] font-mono leading-relaxed focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Paste peer's code here..."></textarea>
                            <button id="btnAcceptAnswer" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-3 px-6 rounded-2xl transition shadow-lg">
                                Establish P2P Link
                            </button>
                        </div>
                    </div>

                    <!-- Join View -->
                    <div id="joinSection" class="hidden space-y-6 tab-content">
                        <div class="space-y-3">
                            <h3 class="font-bold text-slate-800 text-emerald-600">1. Accept Invitation</h3>
                            <p class="text-sm text-slate-500">Paste the code sent to you by the host.</p>
                            <textarea id="remoteOfferInput" class="w-full h-28 p-4 border border-slate-200 rounded-2xl text-[10px] font-mono leading-relaxed focus:ring-2 focus:ring-emerald-500 outline-none resize-none" placeholder="Paste host's code here..."></textarea>
                            <button id="btnCreateAnswer" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-2xl transition-all shadow-lg shadow-emerald-100 flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-5 h-5"></i> Generate My Answer
                            </button>
                        </div>

                        <div class="space-y-3 pt-6 border-t border-slate-100">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">Your Response Code</label>
                            <div class="relative">
                                <textarea id="localAnswerSdp" readonly class="w-full h-28 p-4 bg-slate-50 border border-slate-200 rounded-2xl text-[10px] font-mono leading-relaxed focus:ring-2 focus:ring-emerald-500 outline-none resize-none" placeholder="Your code will appear here..."></textarea>
                                <button id="btnCopyAnswer" class="absolute bottom-3 right-3 bg-white border border-slate-200 p-2 rounded-xl hover:bg-slate-50 transition shadow-sm">
                                    <i data-lucide="copy" class="w-4 h-4 text-emerald-600"></i>
                                </button>
                            </div>
                            <p class="text-[11px] text-center text-slate-400">Send this back to the host to start the call.</p>
                        </div>
                    </div>
                </div>
            </div>

            <button onclick="location.reload()" class="text-slate-400 hover:text-red-500 text-xs font-bold uppercase tracking-widest py-4 transition flex items-center justify-center gap-2">
                <i data-lucide="refresh-ccw" class="w-3 h-3"></i> Reset Session
            </button>
        </div>
    </div>

    <!-- Hidden Audio Elements -->
    <audio id="remoteAudio" autoplay></audio>

    <script>
        window.onload = function() {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            };

            let pc = new RTCPeerConnection(config);
            let localStream = null;

            const stateEl = document.getElementById('connState');
            const remoteAudio = document.getElementById('remoteAudio');
            
            // Tab Management
            const tabCaller = document.getElementById('tabCaller');
            const tabReceiver = document.getElementById('tabReceiver');
            const hostSection = document.getElementById('hostSection');
            const joinSection = document.getElementById('joinSection');

            function switchTab(isHost) {
                if (isHost) {
                    tabCaller.className = "flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm bg-white shadow-sm text-blue-600";
                    tabReceiver.className = "flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm text-slate-500 hover:bg-white/50";
                    hostSection.classList.remove('hidden');
                    joinSection.classList.add('hidden');
                } else {
                    tabReceiver.className = "flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm bg-white shadow-sm text-emerald-600";
                    tabCaller.className = "flex-1 flex items-center justify-center gap-2 py-3 rounded-2xl font-bold text-sm text-slate-500 hover:bg-white/50";
                    joinSection.classList.remove('hidden');
                    hostSection.classList.add('hidden');
                }
            }

            tabCaller.onclick = () => switchTab(true);
            tabReceiver.onclick = () => switchTab(false);

            // Audio Logic
            async function ensureAudioContext(ctx) {
                if (ctx.state === 'suspended') await ctx.resume();
            }

            function createBars(container, count = 25) {
                for (let i = 0; i < count; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'bar' + (container.id === 'remoteVisualizer' ? ' remote-bar' : '');
                    container.appendChild(bar);
                }
            }
            createBars(document.getElementById('localVisualizer'));
            createBars(document.getElementById('remoteVisualizer'));

            async function visualize(stream, containerId) {
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    await ensureAudioContext(audioContext);
                    const source = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    analyser.fftSize = 64;
                    source.connect(analyser);

                    const dataArray = new Uint8Array(analyser.frequencyBinCount);
                    const bars = document.querySelectorAll(`#${containerId} .bar`);

                    function update() {
                        analyser.getByteFrequencyData(dataArray);
                        for (let i = 0; i < bars.length; i++) {
                            const val = dataArray[i] || 0;
                            const height = Math.max(4, (val / 255) * 50);
                            bars[i].style.height = `${height}px`;
                        }
                        requestAnimationFrame(update);
                    }
                    update();
                } catch (e) { console.error(e); }
            }

            async function startLocalStream() {
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                    await visualize(localStream, 'localVisualizer');
                } catch (err) {
                    console.error("Mic access denied", err);
                    alert("Microphone access is required for P2P voice chat.");
                }
            }

            pc.oniceconnectionstatechange = () => {
                stateEl.innerText = pc.iceConnectionState;
                const baseClasses = "px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-widest ";
                if (pc.iceConnectionState === 'connected') {
                    stateEl.className = baseClasses + "bg-emerald-100 text-emerald-600";
                } else if (['failed', 'disconnected', 'closed'].includes(pc.iceConnectionState)) {
                    stateEl.className = baseClasses + "bg-red-100 text-red-600";
                } else {
                    stateEl.className = baseClasses + "bg-blue-100 text-blue-600";
                }
            };

            pc.ontrack = (event) => {
                remoteAudio.srcObject = event.streams[0];
                visualize(event.streams[0], 'remoteVisualizer');
            };

            const waitForIce = (pc) => {
                return new Promise(resolve => {
                    if (pc.iceGatheringState === 'complete') resolve();
                    else {
                        const checkState = () => {
                            if (pc.iceGatheringState === 'complete') {
                                pc.removeEventListener('icegatheringstatechange', checkState);
                                resolve();
                            }
                        };
                        pc.addEventListener('icegatheringstatechange', checkState);
                    }
                });
            };

            // Handshake Handlers
            document.getElementById('btnCreateOffer').onclick = async () => {
                await startLocalStream();
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                document.getElementById('localSdp').value = "Gathering network info...";
                await waitForIce(pc);
                document.getElementById('localSdp').value = btoa(JSON.stringify(pc.localDescription));
            };

            document.getElementById('btnAcceptAnswer').onclick = async () => {
                const answerStr = document.getElementById('remoteAnswerInput').value;
                if (!answerStr) return alert("Please paste the answer code from your peer.");
                try {
                    const answer = JSON.parse(atob(answerStr));
                    await pc.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (e) { alert("Invalid code provided."); }
            };

            document.getElementById('btnCreateAnswer').onclick = async () => {
                const offerStr = document.getElementById('remoteOfferInput').value;
                if (!offerStr) return alert("Please paste the offer code from the host.");
                try {
                    await startLocalStream();
                    const offer = JSON.parse(atob(offerStr));
                    await pc.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    document.getElementById('localAnswerSdp').value = "Preparing response...";
                    await waitForIce(pc);
                    document.getElementById('localAnswerSdp').value = btoa(JSON.stringify(pc.localDescription));
                } catch (e) { alert("Invalid offer code."); }
            };

            // Copy logic
            const setupCopy = (btnId, textId) => {
                document.getElementById(btnId).onclick = () => {
                    const text = document.getElementById(textId).value;
                    if (!text || text.includes('...')) return;
                    const el = document.createElement('textarea');
                    el.value = text;
                    document.body.appendChild(el);
                    el.select();
                    document.execCommand('copy');
                    document.body.removeChild(el);
                    
                    const btn = document.getElementById(btnId);
                    const originalIcon = btn.innerHTML;
                    btn.innerHTML = '<i data-lucide="check" class="w-4 h-4 text-emerald-500"></i>';
                    lucide.createIcons();
                    setTimeout(() => { 
                        btn.innerHTML = originalIcon;
                        lucide.createIcons();
                    }, 2000);
                };
            };
            setupCopy('btnCopyOffer', 'localSdp');
            setupCopy('btnCopyAnswer', 'localAnswerSdp');
        };
    </script>
</body>
</html>