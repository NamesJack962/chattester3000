<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Voice Chat | Password Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <style>
        .visualizer-container {
            height: 60px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .bar {
            flex: 1;
            background: #3b82f6;
            min-height: 4px;
            border-radius: 2px;
            transition: height 0.05s ease;
        }
        .remote-bar { background: #10b981; }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        .pulse-dot::before {
            content: '';
            position: absolute; width: 300%; height: 300%;
            left: -100%; top: -100%;
            border-radius: 45px; background-color: currentColor;
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900 font-sans">

    <div class="max-w-xl mx-auto px-4 py-12">
        <!-- Header -->
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center p-4 bg-blue-600 text-white rounded-3xl shadow-lg shadow-blue-200 mb-6">
                <i data-lucide="mic" class="w-8 h-8"></i>
            </div>
            <h1 class="text-4xl font-extrabold tracking-tight text-slate-900">Voice Link</h1>
            <p class="text-slate-500 mt-2">Enter a password to start a private P2P call</p>
        </header>

        <!-- Main Interface -->
        <div class="grid gap-6">
            
            <!-- Connection Status Card -->
            <div id="statusCard" class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5 text-blue-500"></i> Status
                    </h2>
                    <div id="connStateWrapper" class="flex items-center gap-2">
                        <div id="statusPulse" class="relative hidden w-2 h-2 rounded-full bg-emerald-500 pulse-dot"></div>
                        <span id="connState" class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-100 text-slate-500 uppercase tracking-widest">Idle</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block">You</span>
                        <div id="localVisualizer" class="visualizer-container bg-slate-50 rounded-2xl px-4 border border-slate-100"></div>
                    </div>
                    <div class="space-y-2">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block">Peer</span>
                        <div id="remoteVisualizer" class="visualizer-container bg-slate-50 rounded-2xl px-4 border border-slate-100"></div>
                    </div>
                </div>
            </div>

            <!-- Join/Host Control -->
            <div id="setupView" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 space-y-6">
                <div class="space-y-4">
                    <label class="block text-sm font-bold text-slate-700">Set Call Password</label>
                    <div class="relative">
                        <input type="text" id="roomPassword" class="w-full px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl text-lg font-mono focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 outline-none transition-all" placeholder="e.g. secret-pizza-123">
                        <i data-lucide="lock" class="absolute right-5 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-300"></i>
                    </div>
                    <p class="text-xs text-slate-400">Share this password with your friend. Both must enter the same one.</p>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button id="btnHost" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-2xl transition shadow-lg shadow-blue-100 flex flex-col items-center gap-1 group">
                        <i data-lucide="radio" class="w-5 h-5 group-hover:scale-110 transition"></i>
                        <span class="text-xs">Host Room</span>
                    </button>
                    <button id="btnJoin" class="bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl transition shadow-lg shadow-slate-200 flex flex-col items-center gap-1 group">
                        <i data-lucide="user-plus" class="w-5 h-5 group-hover:scale-110 transition"></i>
                        <span class="text-xs">Join Room</span>
                    </button>
                </div>
            </div>

            <div id="activeView" class="hidden text-center">
                <button onclick="location.reload()" class="bg-red-50 text-red-500 hover:bg-red-100 px-8 py-3 rounded-full text-xs font-bold uppercase tracking-widest transition inline-flex items-center gap-2">
                    <i data-lucide="phone-off" class="w-4 h-4"></i> End Call & Reset
                </button>
            </div>
        </div>
    </div>

    <audio id="remoteAudio" autoplay></audio>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'voice-p2p-app';

        let pc = null;
        let localStream = null;
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:stun1.l.google.com:19302' }] };

        // UI Refs
        const stateEl = document.getElementById('connState');
        const statusPulse = document.getElementById('statusPulse');
        const setupView = document.getElementById('setupView');
        const activeView = document.getElementById('activeView');
        const roomInput = document.getElementById('roomPassword');
        const remoteAudio = document.getElementById('remoteAudio');

        window.onload = () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            createBars(document.getElementById('localVisualizer'));
            createBars(document.getElementById('remoteVisualizer'));
        };

        // UI Helpers
        function createBars(container, count = 20) {
            for (let i = 0; i < count; i++) {
                const bar = document.createElement('div');
                bar.className = 'bar' + (container.id === 'remoteVisualizer' ? ' remote-bar' : '');
                container.appendChild(bar);
            }
        }

        async function visualize(stream, containerId) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            if (audioContext.state === 'suspended') await audioContext.resume();
            const source = audioContext.createMediaStreamSource(stream);
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = 64;
            source.connect(analyser);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            const bars = document.querySelectorAll(`#${containerId} .bar`);
            function update() {
                analyser.getByteFrequencyData(dataArray);
                for (let i = 0; i < bars.length; i++) {
                    const val = dataArray[i] || 0;
                    bars[i].style.height = `${Math.max(4, (val / 255) * 50)}px`;
                }
                requestAnimationFrame(update);
            }
            update();
        }

        // WebRTC Logic
        async function initCall() {
            pc = new RTCPeerConnection(config);
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
            visualize(localStream, 'localVisualizer');

            pc.ontrack = (event) => {
                remoteAudio.srcObject = event.streams[0];
                visualize(event.streams[0], 'remoteVisualizer');
            };

            pc.oniceconnectionstatechange = () => {
                stateEl.innerText = pc.iceConnectionState;
                if (pc.iceConnectionState === 'connected') {
                    statusPulse.classList.remove('hidden');
                    stateEl.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-emerald-100 text-emerald-600 uppercase tracking-widest";
                }
            };
        }

        async function getRoomDoc(password) {
            // Path structure: /artifacts/{appId}/public/data/rooms/{password}
            return doc(db, 'artifacts', appId, 'public', 'data', 'rooms', password.trim().toLowerCase());
        }

        // Action Handlers
        document.getElementById('btnHost').onclick = async () => {
            const pwd = roomInput.value;
            if (!pwd) return alert("Enter a password first!");
            
            setupView.classList.add('opacity-50', 'pointer-events-none');
            stateEl.innerText = "Authenticating...";

            await signInAnonymously(auth);
            await initCall();
            
            const roomDoc = await getRoomDoc(pwd);

            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidatesCol = collection(roomDoc, 'callerCandidates');
                    addDoc(candidatesCol, event.candidate.toJSON());
                }
            };

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);

            await setDoc(roomDoc, { offer: { type: offer.type, sdp: offer.sdp } });
            
            stateEl.innerText = "Waiting for peer...";
            setupView.classList.add('hidden');
            activeView.classList.remove('hidden');

            // Listen for Answer
            onSnapshot(roomDoc, (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.answer) {
                    const answerDesc = new RTCSessionDescription(data.answer);
                    pc.setRemoteDescription(answerDesc);
                }
            });

            // Listen for Remote ICE
            onSnapshot(collection(roomDoc, 'calleeCandidates'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                    }
                });
            });
        };

        document.getElementById('btnJoin').onclick = async () => {
            const pwd = roomInput.value;
            if (!pwd) return alert("Enter a password first!");

            setupView.classList.add('opacity-50', 'pointer-events-none');
            stateEl.innerText = "Connecting...";

            await signInAnonymously(auth);
            await initCall();

            const roomDoc = await getRoomDoc(pwd);

            // Listen for Offer
            onSnapshot(roomDoc, async (snapshot) => {
                const data = snapshot.data();
                if (!pc.currentRemoteDescription && data?.offer) {
                    await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    await updateDoc(roomDoc, { answer: { type: answer.type, sdp: answer.sdp } });
                    
                    setupView.classList.add('hidden');
                    activeView.classList.remove('hidden');
                }
            });

            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    const candidatesCol = collection(roomDoc, 'calleeCandidates');
                    addDoc(candidatesCol, event.candidate.toJSON());
                }
            };

            // Listen for Remote ICE
            onSnapshot(collection(roomDoc, 'callerCandidates'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        pc.addIceCandidate(new RTCIceCandidate(change.doc.data()));
                    }
                });
            });
        };
    </script>
</body>
</html>

