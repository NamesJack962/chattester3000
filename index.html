<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forest Whispers - Lofi Voice Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap');
        
        :root {
            --woods-moss: #4A5D4E;
            --woods-bark: #3E362E;
            --woods-fog: #E8EBE4;
            --woods-paper: #FDFBF7;
            --woods-leaf: #A3B18A;
            --woods-clay: #D4A373;
            --woods-shadow: rgba(62, 54, 46, 0.08);
            --door-active: #C19A6B; 
            --door-inactive: #94a3b8;
        }

        body { 
            font-family: 'Quicksand', sans-serif; 
            background-color: var(--woods-fog); 
            color: var(--woods-bark);
            -webkit-font-smoothing: antialiased;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        h1, h2, h3, .serif { font-family: 'Lora', serif; }

        .lofi-btn-primary {
            height: 52px;
            padding: 0 32px;
            border-radius: 30px;
            background-color: var(--woods-moss);
            color: var(--woods-paper);
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 0px #354238;
        }
        .lofi-btn-primary:hover { transform: translateY(2px); box-shadow: 0 2px 0px #354238; }

        .lofi-btn-secondary {
            height: 52px;
            padding: 0 32px;
            border-radius: 30px;
            border: 2px solid var(--woods-moss);
            color: var(--woods-moss);
            font-weight: 700;
            transition: all 0.2s;
        }

        .lofi-card {
            background-color: var(--woods-paper);
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(74, 93, 78, 0.15);
            box-shadow: 0 8px 24px var(--woods-shadow);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lofi-input {
            background-color: rgba(255, 255, 255, 0.5);
            border: 2px solid var(--woods-leaf);
            border-radius: 18px;
            padding: 14px 20px;
            color: var(--woods-bark);
            width: 100%;
            transition: all 0.2s;
        }

        /* Door Styles with Icons */
        .door-container {
            width: 36px;
            height: 52px;
            position: relative;
            perspective: 600px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .door-frame {
            position: absolute;
            inset: 0;
            background: #cbd5e1;
            border-radius: 4px;
            overflow: hidden;
            border: 2px solid #94a3b8;
        }

        .door-frame::after {
            content: '';
            position: absolute;
            inset: 0;
            background: var(--door-active);
            opacity: 0;
            transition: opacity 0.4s;
        }

        .door-leaf {
            position: absolute;
            inset: 0;
            background: var(--door-inactive);
            border-radius: 1px;
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 0.4s;
            z-index: 2;
            border-right: 1px solid rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .door-status-icon {
            width: 14px;
            height: 14px;
            color: white;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        /* Animation States */
        .listening-only .door-leaf { transform: rotateY(-35deg); background: var(--door-active); }
        .listening-only .door-frame::after { opacity: 0.4; }

        /* Speaking Indicator */
        .speaking-indicator {
            box-shadow: 0 0 15px var(--woods-leaf);
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Chat Styles */
        .chat-sidebar {
            width: 320px;
            background: var(--woods-paper);
            border-left: 1px solid rgba(74, 93, 78, 0.1);
            display: flex;
            flex-direction: column;
        }

        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .message {
            max-width: 85%;
            padding: 0.6rem 0.8rem;
            border-radius: 16px;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .message-received {
            background: var(--woods-fog);
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message-sent {
            background: var(--woods-moss);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .system-message {
            align-self: center;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--woods-leaf);
            font-weight: 700;
            opacity: 0.7;
        }

        .leaf-badge {
            font-size: 11px;
            font-weight: 700;
            padding: 4px 14px;
            border-radius: 20px;
            background: var(--woods-leaf);
            color: white;
        }

        .yt-hidden {
            position: absolute;
            width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); border: 0;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <main id="app-container" class="flex-1 flex overflow-hidden">
        
        <!-- Setup Views -->
        <div id="setup-view" class="absolute inset-0 z-[60] flex flex-col items-center justify-center p-8 bg-[--woods-fog]">
            <div class="w-full max-w-xl space-y-12">
                <div class="text-center space-y-4">
                    <h2 class="text-4xl font-bold text-[--woods-bark]">Enter the Grove</h2>
                    <p class="opacity-60">A place for quiet voices and deep focus.</p>
                </div>
                <div class="grid grid-cols-2 gap-4 w-full px-6">
                    <button onclick="handleHost()" class="lofi-btn-primary">Start a Circle</button>
                    <button onclick="showJoinInput()" class="lofi-btn-secondary">Find a Grove</button>
                </div>
                <div class="space-y-8 w-full px-6 py-10 bg-[--woods-paper] rounded-[32px] border border-[rgba(74,93,78,0.1)] shadow-xl">
                    <input id="setup-username-input" type="text" placeholder="Your Spirit Name" class="lofi-input text-lg text-center">
                </div>
            </div>
        </div>

        <div id="join-view" class="hidden absolute inset-0 z-[60] flex flex-col items-center justify-center p-8 bg-[--woods-fog]">
            <div class="w-full max-w-md space-y-10 text-center">
                <h3 class="text-3xl font-bold">Follow the Path</h3>
                <input id="join-room-id" type="text" placeholder="CODE" class="w-full bg-transparent border-b-2 border-[--woods-moss] p-4 text-center text-5xl font-bold uppercase focus:outline-none">
                <div class="flex flex-col gap-4">
                    <button onclick="handleJoin()" class="lofi-btn-primary w-full">Join</button>
                    <button onclick="showSetup()" class="text-sm font-bold opacity-40 uppercase">Back</button>
                </div>
            </div>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="hidden w-full h-full flex overflow-hidden">
            <!-- Sidebar: Navigation -->
            <aside class="w-72 bg-[--woods-paper] border-r border-[rgba(74,93,78,0.1)] flex flex-col z-20 h-full">
                <div class="h-20 flex items-center justify-between px-6 border-b border-[rgba(74,93,78,0.05)]">
                    <h3 class="text-[10px] font-bold text-[--woods-moss] uppercase tracking-[0.2em]">Clearings</h3>
                    <button onclick="toggleRoomModal()" class="text-[--woods-moss] hover:rotate-90 transition-transform">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                </div>
                
                <div id="subroom-list" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
                
                <div class="p-6 border-t border-[rgba(74,93,78,0.05)] bg-[--woods-paper]">
                    <div class="p-4 bg-[--woods-fog] rounded-2xl border border-[--woods-leaf] flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-[--woods-moss] text-white flex items-center justify-center font-bold text-xs" id="local-avatar-char">?</div>
                        <div class="flex-1 min-w-0">
                            <div class="font-bold truncate text-xs" id="local-name-display">Wanderer</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Workspace -->
            <div class="flex-1 flex flex-col bg-white/30">
                <header class="h-20 px-10 flex items-center justify-between border-b border-[rgba(74,93,78,0.1)] bg-[--woods-paper]/80 backdrop-blur-md">
                    <div class="flex items-center gap-4">
                        <h1 class="text-lg font-bold text-[--woods-moss]">Forest Whispers</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="toggleMusicModal()" class="flex items-center gap-2 bg-[--woods-fog] px-4 py-2 rounded-full border border-[--woods-leaf] text-[10px] font-bold uppercase hover:bg-white transition-colors">
                            <span id="now-playing-title">Ambient Music</span>
                        </button>
                        <button onclick="copyRoomId()" class="text-[10px] font-bold text-[--woods-moss] bg-[--woods-fog] px-4 py-2 rounded-full border border-[--woods-leaf] hover:bg-white transition-colors">
                            <span id="room-id-text">CODE</span>
                        </button>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto p-12">
                    <div class="max-w-5xl mx-auto">
                        <div class="flex items-center justify-between mb-10">
                            <div>
                                <h2 class="text-2xl font-bold text-[--woods-moss]" id="current-room-label">Primary Clearing</h2>
                            </div>
                            <span id="peer-count-badge" class="leaf-badge">0 SPIRITS</span>
                        </div>
                        <div id="peer-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>

                <footer class="h-24 bg-[--woods-paper] border-t border-[rgba(74,93,78,0.1)] px-10 flex items-center justify-between">
                    <button id="mute-btn" onclick="toggleMute()" class="w-12 h-12 rounded-full bg-[--woods-fog] border-2 border-[--woods-leaf] flex items-center justify-center text-[--woods-moss] transition-all">
                        <svg id="mic-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        </svg>
                    </button>
                    <button onclick="location.reload()" class="lofi-btn-primary !h-12 !bg-orange-800 !shadow-none">Depart</button>
                </footer>
            </div>

            <!-- Chat Sidebar -->
            <aside class="chat-sidebar">
                <div class="h-20 px-6 flex items-center border-b border-[rgba(74,93,78,0.05)]">
                    <h3 class="text-[10px] font-bold text-[--woods-moss] uppercase tracking-[0.2em]">Whispers</h3>
                </div>
                <div id="chat-messages">
                    <div class="system-message">Welcome to the grove.</div>
                </div>
                <div class="p-4 border-t border-[rgba(74,93,78,0.05)]">
                    <div class="relative">
                        <input id="chat-input" type="text" placeholder="Speak softly..." class="lofi-input !py-3 !text-sm !pr-12" onkeydown="if(event.key==='Enter') sendChatMessage()">
                        <button onclick="sendChatMessage()" class="absolute right-3 top-1/2 -translate-y-1/2 text-[--woods-moss] opacity-60 hover:opacity-100 transition-opacity">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </aside>
        </div>
    </main>

    <!-- Modals -->
    <div id="youtube-anchor" class="yt-hidden"></div>
    <div id="music-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-[--woods-bark]/40 backdrop-blur-md">
        <div class="bg-[--woods-paper] rounded-[32px] w-full max-w-sm p-10 space-y-6">
            <h3 class="text-xl font-bold text-center">Grove Radio</h3>
            <input id="yt-link-input" type="text" placeholder="YouTube Link" class="lofi-input">
            <button onclick="playSharedMusic()" class="lofi-btn-primary w-full">Broadcast</button>
            <button onclick="toggleMusicModal()" class="text-xs font-bold opacity-40 uppercase w-full text-center">Close</button>
        </div>
    </div>
    <div id="room-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-6 bg-[--woods-bark]/40 backdrop-blur-md">
        <div class="bg-[--woods-paper] rounded-[32px] w-full max-w-sm p-10 space-y-6">
            <h3 class="text-xl font-bold text-center">New Clearing</h3>
            <input id="subroom-name-input" type="text" placeholder="Clearing Name" class="lofi-input">
            <button onclick="confirmCreateSubRoom()" class="lofi-btn-primary w-full">Create</button>
            <button onclick="toggleRoomModal()" class="text-xs font-bold opacity-40 uppercase w-full text-center">Cancel</button>
        </div>
    </div>
    <div id="toast-container" class="fixed bottom-10 right-[340px] z-[200] flex flex-col gap-3"></div>

    <script>
        const PREFS_KEY = 'p2p_voice_lofi_woods_v6';
        let prefs = { username: '', listeningRooms: ['main'] }; 
        let peer = null, localStream = null, isMuted = false;
        let remotePeers = {}, currentSubRoom = 'main', subRooms = { 'main': 'Primary Clearing' }, connections = {};
        let ytPlayer = null, currentVideoId = null;

        // Icons
        const ICON_MIC_OFF = `<svg class="door-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
        const ICON_MIC_ON = `<svg class="door-status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;

        function onYouTubeIframeAPIReady() {
            ytPlayer = new YT.Player('youtube-anchor', {
                height: '0', width: '0', videoId: '',
                playerVars: { 'autoplay': 1, 'controls': 0 },
                events: { 'onReady': (e) => e.target.setVolume(50) }
            });
        }

        function toggleMusicModal() { document.getElementById('music-modal').classList.toggle('hidden'); }
        function toggleRoomModal() { document.getElementById('room-modal').classList.toggle('hidden'); }

        function loadPreferences() {
            const saved = localStorage.getItem(PREFS_KEY);
            if (saved) prefs = JSON.parse(saved);
            document.getElementById('setup-username-input').value = prefs.username || '';
        }

        function savePreferences() {
            localStorage.setItem(PREFS_KEY, JSON.stringify(prefs));
        }

        async function requestInitialMedia() {
            try {
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                setupVolumeAnalysis(localStream, 'local');
                return localStream;
            } catch (e) { showToast("Mic access denied"); return null; }
        }

        function showJoinInput() { 
            document.getElementById('setup-view').classList.add('hidden'); 
            document.getElementById('join-view').classList.remove('hidden'); 
        }

        function showSetup() { 
            document.getElementById('join-view').classList.add('hidden'); 
            document.getElementById('setup-view').classList.remove('hidden'); 
        }

        function enterLobby() {
            prefs.username = document.getElementById('setup-username-input').value || 'Spirit_' + Math.floor(Math.random()*999);
            savePreferences();
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('join-view').classList.add('hidden');
            document.getElementById('lobby-view').classList.remove('hidden');
            document.getElementById('local-avatar-char').innerText = prefs.username[0].toUpperCase();
            document.getElementById('local-name-display').innerText = prefs.username;
            renderSubRooms();
        }

        function initPeer(id = null) {
            peer = id ? new Peer(id) : new Peer();
            peer.on('open', (newId) => { document.getElementById('room-id-text').innerText = peer.id.toUpperCase(); });
            peer.on('connection', setupConnection);
            peer.on('call', (call) => {
                call.answer(localStream);
                call.on('stream', (stream) => handleRemoteStream(call.peer, stream));
            });
        }

        function setupConnection(conn) {
            conn.on('open', () => {
                connections[conn.peer] = conn;
                broadcastSync();
            });
            conn.on('data', (data) => {
                if (data.type === 'sync') {
                    Object.assign(subRooms, data.subRooms);
                    if (remotePeers[conn.peer]) {
                        if (remotePeers[conn.peer].currentSubRoom !== data.userRoom) {
                            addSystemMessage(`${data.username} moved to ${subRooms[data.userRoom]}`);
                        }
                        remotePeers[conn.peer].currentSubRoom = data.userRoom;
                        remotePeers[conn.peer].username = data.username;
                    }
                    renderSubRooms();
                    updatePeerVisibility();
                } else if (data.type === 'chat') {
                    addChatMessage(data.username, data.text, false);
                } else if (data.type === 'music') {
                    if (data.videoId !== currentVideoId) {
                        currentVideoId = data.videoId;
                        ytPlayer.loadVideoById(data.videoId);
                        addSystemMessage(`Music changed to: ${data.videoId}`);
                    }
                }
            });
            conn.on('close', () => { 
                if (remotePeers[conn.peer]) {
                    addSystemMessage(`${remotePeers[conn.peer].username} vanished.`);
                    remotePeers[conn.peer].element.remove();
                    delete remotePeers[conn.peer];
                }
                delete connections[conn.peer];
                renderSubRooms();
                updatePeerCount();
            });
        }

        function broadcastSync() {
            Object.values(connections).forEach(c => {
                c.send({ type: 'sync', subRooms, userRoom: currentSubRoom, username: prefs.username });
            });
        }

        async function handleHost() {
            if (!localStream) await requestInitialMedia();
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            initPeer(id);
            createPeerCard('local', prefs.username || 'Wanderer');
            enterLobby();
        }

        async function handleJoin() {
            const target = document.getElementById('join-room-id').value.toUpperCase();
            if (!target) return;
            if (!localStream) await requestInitialMedia();
            initPeer();
            peer.on('open', () => {
                const conn = peer.connect(target);
                setupConnection(conn);
                peer.call(target, localStream);
                createPeerCard('local', prefs.username || 'Visitor');
                enterLobby();
            });
        }

        function handleRemoteStream(id, stream) {
            if (!remotePeers[id]) {
                const audio = new Audio(); audio.srcObject = stream; audio.play();
                const card = createPeerCard(id, `Spirit_${id.substring(0,4)}`);
                remotePeers[id] = { stream, element: card, currentSubRoom: 'main', audio, username: `Spirit_${id.substring(0,4)}` };
                setupVolumeAnalysis(stream, id);
                updatePeerVisibility();
                updatePeerCount();
                renderSubRooms();
                addSystemMessage(`A wisp named Spirit_${id.substring(0,2)} appeared.`);
            }
        }

        function renderSubRooms() {
            const list = document.getElementById('subroom-list');
            list.innerHTML = '';
            
            Object.keys(subRooms).forEach(roomId => {
                const isActive = currentSubRoom === roomId;
                const isListening = prefs.listeningRooms.includes(roomId);
                const listeningOnly = isListening && !isActive;
                
                const container = document.createElement('div');
                container.className = `channel-item p-3 flex items-center gap-3 cursor-pointer ${isActive ? 'active' : 'hover:bg-black/5'} ${listeningOnly ? 'listening-only' : ''}`;
                
                // Door: Interactive
                const door = document.createElement('div');
                door.className = 'door-container';
                door.innerHTML = `
                    <div class="door-frame"></div>
                    <div class="door-leaf">
                        ${isActive ? ICON_MIC_ON : ICON_MIC_OFF}
                    </div>
                `;
                door.onclick = (e) => { 
                    e.stopPropagation(); 
                    if (!isActive) toggleListening(roomId); 
                };
                container.appendChild(door);
                
                const content = document.createElement('div');
                content.className = 'flex-1 min-w-0';
                if (!isActive) content.onclick = () => switchSubRoom(roomId);
                content.innerHTML = `<span class="text-sm font-bold block truncate">${subRooms[roomId]}</span>`;

                const usersDiv = document.createElement('div');
                usersDiv.className = 'flex flex-wrap gap-1 mt-1';
                if (isActive) {
                    const chip = document.createElement('span');
                    chip.className = 'text-[9px] opacity-40 uppercase font-bold px-2 py-0.5 rounded-full bg-black/10';
                    chip.innerText = 'Inside';
                    usersDiv.appendChild(chip);
                }
                Object.values(remotePeers).forEach(p => {
                    if (p.currentSubRoom === roomId) {
                        const chip = document.createElement('span');
                        chip.className = 'text-[9px] px-2 py-0.5 rounded-full bg-[--woods-leaf]/20 text-[--woods-bark]';
                        chip.innerText = p.username.split('_')[0];
                        usersDiv.appendChild(chip);
                    }
                });

                content.appendChild(usersDiv);
                container.appendChild(content);
                list.appendChild(container);
            });
        }

        function createPeerCard(id, name) {
            const div = document.createElement('div');
            div.id = `peer-${id}`;
            div.className = `lofi-card transition-all duration-500`;
            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <div id="avatar-${id}" class="w-12 h-12 rounded-xl bg-[--woods-fog] flex items-center justify-center font-bold text-lg text-[--woods-moss] border border-[--woods-moss]/10">
                        ${name[0].toUpperCase()}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="font-bold truncate text-sm">${name}</div>
                        <div class="h-1.5 bg-black/5 rounded-full mt-2 overflow-hidden">
                            <div id="vol-${id}" class="h-full bg-[--woods-leaf] transition-all duration-75" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('peer-grid').appendChild(div);
            return div;
        }

        function toggleListening(id) {
            if (currentSubRoom === id) return;
            if (prefs.listeningRooms.includes(id)) {
                prefs.listeningRooms = prefs.listeningRooms.filter(r => r !== id);
                addSystemMessage(`Left ${subRooms[id]}.`);
            } else {
                prefs.listeningRooms.push(id);
                addSystemMessage(`Peeking into ${subRooms[id]}...`);
            }
            savePreferences();
            updatePeerVisibility();
            renderSubRooms();
        }

        function switchSubRoom(id) {
            if (currentSubRoom === id) return;
            currentSubRoom = id;
            if (!prefs.listeningRooms.includes(id)) {
                prefs.listeningRooms.push(id);
                savePreferences();
            }
            document.getElementById('current-room-label').innerText = subRooms[id];
            renderSubRooms();
            updatePeerVisibility();
            broadcastSync();
            addSystemMessage(`Entered ${subRooms[id]}.`);
        }

        function updatePeerVisibility() {
            Object.keys(remotePeers).forEach(id => {
                const p = remotePeers[id];
                const isAudible = prefs.listeningRooms.includes(p.currentSubRoom);
                const isVisible = p.currentSubRoom === currentSubRoom;
                p.element.style.display = isVisible ? 'flex' : 'none';
                if (p.audio) p.audio.muted = !isAudible;
            });
            updatePeerCount();
        }

        function updatePeerCount() {
            const count = Object.values(remotePeers).filter(p => p.currentSubRoom === currentSubRoom).length + 1;
            document.getElementById('peer-count-badge').innerText = `${count} SPIRITS`;
        }

        function setupVolumeAnalysis(stream, targetId) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 64;
            const data = new Uint8Array(analyser.frequencyBinCount);
            function update() {
                analyser.getByteFrequencyData(data);
                let avg = (data.reduce((a,b) => a+b) / data.length);
                const bar = document.getElementById(targetId === 'local' ? 'vol-local' : `vol-${targetId}`);
                if (bar) bar.style.width = Math.min(avg * 2.5, 100) + '%';
                const avatar = document.getElementById(targetId === 'local' ? 'avatar-local' : `avatar-${targetId}`);
                if (avatar && avg > 15) avatar.classList.add('speaking-indicator');
                else if (avatar) avatar.classList.remove('speaking-indicator');
                requestAnimationFrame(update);
            }
            update();
        }

        function toggleMute() {
            isMuted = !isMuted;
            if (localStream) localStream.getAudioTracks()[0].enabled = !isMuted;
            const btn = document.getElementById('mute-btn');
            btn.classList.toggle('bg-orange-700', isMuted);
            btn.classList.toggle('text-white', isMuted);
            document.getElementById('mic-icon').innerHTML = isMuted ? 
                `<line x1="1" y1="1" x2="23" y2="23"></line><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"></path><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line>` :
                `<path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>`;
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            addChatMessage('You', text, true);
            Object.values(connections).forEach(c => {
                c.send({ type: 'chat', username: prefs.username, text });
            });
            input.value = '';
        }

        function addChatMessage(user, text, isMe) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `message ${isMe ? 'message-sent' : 'message-received'}`;
            div.innerHTML = `<div class="text-[10px] font-bold opacity-60 mb-1">${user}</div><div>${text}</div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = `system-message`;
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function playSharedMusic() {
            const link = document.getElementById('yt-link-input').value;
            const match = link.match(/[?&]v=([^&#]+)/) || link.match(/youtu\.be\/([^?&#]+)/);
            if (match) {
                const vid = match[1];
                currentVideoId = vid;
                ytPlayer.loadVideoById(vid);
                Object.values(connections).forEach(c => c.send({ type: 'music', videoId: vid }));
                toggleMusicModal();
                addSystemMessage(`Broadcasting a new tune.`);
            }
        }

        function confirmCreateSubRoom() {
            const name = document.getElementById('subroom-name-input').value;
            if (!name) return;
            const id = 'room-' + Math.random().toString(36).substring(2, 6);
            subRooms[id] = name; 
            switchSubRoom(id);
            toggleRoomModal();
        }

        function copyRoomId() {
            const text = document.getElementById('room-id-text').innerText;
            const temp = document.createElement('input');
            document.body.appendChild(temp);
            temp.value = text;
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            showToast("Grove code copied.");
        }

        function showToast(m) {
            const c = document.getElementById('toast-container');
            const d = document.createElement('div');
            d.className = `px-6 py-3 rounded-xl bg-white text-xs font-bold shadow-lg border border-[--woods-leaf] animate-in slide-in-from-right`;
            d.innerText = m;
            c.appendChild(d);
            setTimeout(() => {
                d.classList.add('animate-out', 'fade-out');
                setTimeout(() => d.remove(), 500);
            }, 3000);
        }

        window.onload = loadPreferences;
    </script>
</body>
</html>
