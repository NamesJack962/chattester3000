<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Voice Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0F1115; color: #f3f4f6; }
        .peer-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .speaking { border-color: #6366f1 !important; box-shadow: 0 0 15px rgba(99, 102, 241, 0.2); }
        .volume-bar { transition: width 0.05s linear; }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-indigo-500/30">

    <!-- Header -->
    <header class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#0F1115]/80 backdrop-blur-md sticky top-0 z-10">
        <div class="flex items-center gap-2">
            <div id="status-indicator" class="w-3 h-3 rounded-full bg-gray-500"></div>
            <h1 class="font-bold tracking-tight text-lg">P2P VOICE</h1>
        </div>
        <div id="room-display" class="hidden flex items-center gap-4">
            <button onclick="copyRoomId()" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-3 py-1.5 rounded-md text-sm transition-colors border border-gray-700">
                <span id="room-id-text" class="font-mono">------</span>
            </button>
        </div>
    </header>

    <!-- Main View Container -->
    <main id="app-container" class="flex-1 flex flex-col items-center justify-center p-6 max-w-4xl mx-auto w-full">
        
        <!-- Setup View -->
        <div id="setup-view" class="w-full max-w-sm space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold mb-2">Welcome</h2>
                <p class="text-gray-400 text-sm">Ultra-lightweight peer-to-peer voice</p>
            </div>
            <div class="space-y-4">
                <div class="space-y-2">
                    <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Your Identity</label>
                    <input id="username-input" type="text" placeholder="Username" class="w-full bg-[#1A1D23] border border-gray-800 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-white">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="handleHost()" class="flex flex-col items-center justify-center gap-3 p-6 bg-[#1A1D23] border border-gray-800 rounded-xl hover:border-indigo-500 hover:bg-indigo-500/5 transition-all group">
                        <span class="text-indigo-400 font-semibold">Host Room</span>
                    </button>
                    <button onclick="showJoinInput()" class="flex flex-col items-center justify-center gap-3 p-6 bg-[#1A1D23] border border-gray-800 rounded-xl hover:border-emerald-500 hover:bg-emerald-500/5 transition-all group">
                        <span class="text-emerald-400 font-semibold">Join Room</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Join Input View -->
        <div id="join-view" class="hidden w-full max-w-sm space-y-6">
            <div class="space-y-2">
                <label class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Room ID</label>
                <input id="join-room-id" type="text" placeholder="PASTE ID" class="w-full bg-[#1A1D23] border border-gray-800 rounded-lg p-4 font-mono text-xl text-center tracking-widest focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all text-white">
            </div>
            <div class="flex gap-3">
                <button onclick="showSetup()" class="flex-1 p-3 rounded-lg border border-gray-800 hover:bg-gray-800 transition-colors">Back</button>
                <button onclick="handleJoin()" class="flex-2 bg-emerald-600 hover:bg-emerald-500 px-8 py-3 rounded-lg font-bold transition-colors">Connect</button>
            </div>
        </div>

        <!-- Lobby View -->
        <div id="lobby-view" class="hidden w-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
            <!-- Peers will be injected here -->
        </div>
    </main>

    <!-- Control Bar -->
    <footer id="control-bar" class="hidden p-6 bg-[#0F1115] border-t border-gray-800 sticky bottom-0 flex justify-center items-center gap-4">
        <div class="flex items-center gap-2 bg-[#1A1D23] p-1.5 rounded-2xl border border-gray-800 shadow-xl">
            <button id="mute-btn" onclick="toggleMute()" class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-300 transition-all">Mic</button>
            <button id="settings-btn" onclick="toggleSettings()" class="p-4 rounded-xl bg-gray-800 hover:bg-gray-700 text-gray-300 transition-all">Settings</button>
            <button onclick="location.reload()" class="p-4 rounded-xl bg-rose-500 hover:bg-rose-600 text-white transition-all">Leave</button>
        </div>
    </footer>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="bg-[#1A1D23] border border-gray-800 rounded-3xl w-full max-w-md p-8 space-y-6">
            <h3 class="text-xl font-bold">Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase mb-2 block">Input Mode</label>
                    <select id="input-mode" onchange="updateInputMode()" class="w-full bg-[#0F1115] border border-gray-800 rounded-lg p-3">
                        <option value="open">Open Mic</option>
                        <option value="ptt">Push-to-Talk</option>
                    </select>
                </div>
                <div id="ptt-config" class="hidden">
                    <label class="text-xs text-gray-500 uppercase mb-2 block">PTT Key: <span id="current-key" class="text-indigo-400">Space</span></label>
                    <button onclick="rebindKey()" class="w-full bg-[#0F1115] p-3 rounded-lg border border-gray-700 text-sm">Press to Rebind</button>
                </div>
                <button onclick="toggleSettings()" class="w-full bg-indigo-600 p-3 rounded-xl font-bold">Done</button>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let peer = null;
        let localStream = null;
        let username = localStorage.getItem('p2p_username') || '';
        let isMuted = false;
        let inputMode = 'open';
        let pttKey = 'Space';
        let isPttPressed = false;
        let remotePeers = {}; // { peerId: { stream, element } }

        document.getElementById('username-input').value = username;

        // --- Navigation ---
        function showJoinInput() {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('join-view').classList.remove('hidden');
        }

        function showSetup() {
            document.getElementById('join-view').classList.add('hidden');
            document.getElementById('setup-view').classList.remove('hidden');
        }

        function enterLobby() {
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('join-view').classList.add('hidden');
            document.getElementById('lobby-view').classList.remove('hidden');
            document.getElementById('control-bar').classList.remove('hidden');
            document.getElementById('room-display').classList.remove('hidden');
            document.getElementById('status-indicator').classList.replace('bg-gray-500', 'bg-emerald-500');
        }

        // --- PTT Logic ---
        window.addEventListener('keydown', (e) => {
            if (inputMode === 'ptt' && e.code === pttKey && !isPttPressed) {
                isPttPressed = true;
                if (localStream) localStream.getAudioTracks()[0].enabled = true;
                updateVolumeIndicator('local', true);
            }
        });

        window.addEventListener('keyup', (e) => {
            if (inputMode === 'ptt' && e.code === pttKey) {
                isPttPressed = false;
                if (localStream) localStream.getAudioTracks()[0].enabled = false;
                updateVolumeIndicator('local', false);
            }
        });

        // --- Peer Logic ---
        async function getMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                if (inputMode === 'ptt') localStream.getAudioTracks()[0].enabled = false;
                return localStream;
            } catch (e) {
                console.error("Mic access denied", e);
                return null;
            }
        }

        function createPeerCard(id, name, isLocal = false) {
            const div = document.createElement('div');
            div.id = `peer-${id}`;
            div.className = `peer-card p-4 rounded-2xl border border-gray-800 bg-[#1A1D23]`;
            div.innerHTML = `
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-12 h-12 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400 font-bold border border-indigo-500/30">
                        ${name[0].toUpperCase()}
                    </div>
                    <div>
                        <div class="font-bold">${name} ${isLocal ? '<span class="text-[10px] bg-indigo-500/20 px-1 rounded ml-1">YOU</span>' : ''}</div>
                        <div class="text-[10px] text-gray-500 uppercase tracking-tighter">Connected</div>
                    </div>
                </div>
                <div class="w-full h-1 bg-gray-800 rounded-full mt-2 overflow-hidden">
                    <div id="vol-${id}" class="volume-bar h-full bg-gray-600" style="width: 0%"></div>
                </div>
            `;
            document.getElementById('lobby-view').appendChild(div);
            return div;
        }

        function initPeer(id = null) {
            peer = id ? new Peer(id) : new Peer();
            
            peer.on('open', (newId) => {
                if (!id) console.log("Joined with ID:", newId);
                else {
                    document.getElementById('room-id-text').innerText = id;
                }
            });

            peer.on('call', (call) => {
                call.answer(localStream);
                call.on('stream', (remoteStream) => {
                    if (!remotePeers[call.peer]) {
                        addRemotePeer(call.peer, remoteStream);
                    }
                });
            });
        }

        function addRemotePeer(id, stream) {
            const audio = new Audio();
            audio.srcObject = stream;
            audio.play();
            const card = createPeerCard(id, `User ${id.substring(0, 4)}`);
            remotePeers[id] = { stream, element: card };
            setupVolumeAnalysis(stream, id);
        }

        async function handleHost() {
            username = document.getElementById('username-input').value;
            if (!username) return;
            localStorage.setItem('p2p_username', username);
            
            await getMedia();
            const id = Math.random().toString(36).substring(2, 8).toUpperCase();
            initPeer(id);
            createPeerCard('local', username, true);
            setupVolumeAnalysis(localStream, 'local');
            enterLobby();
        }

        async function handleJoin() {
            const targetRoom = document.getElementById('join-room-id').value;
            username = document.getElementById('username-input').value;
            if (!targetRoom || !username) return;
            
            await getMedia();
            initPeer();
            
            peer.on('open', () => {
                const call = peer.call(targetRoom, localStream);
                call.on('stream', (remoteStream) => {
                    addRemotePeer(targetRoom, remoteStream);
                });
                createPeerCard('local', username, true);
                setupVolumeAnalysis(localStream, 'local');
                enterLobby();
                document.getElementById('room-id-text').innerText = targetRoom;
            });
        }

        // --- Audio Analysis ---
        function setupVolumeAnalysis(stream, id) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 64;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function update() {
                analyser.getByteFrequencyData(dataArray);
                let sum = 0;
                for(let i=0; i<bufferLength; i++) sum += dataArray[i];
                let avg = sum / bufferLength;
                
                const bar = document.getElementById(`vol-${id}`);
                const card = document.getElementById(`peer-${id}`);
                
                if (bar) bar.style.width = Math.min(avg * 2, 100) + '%';
                if (avg > 20) {
                    bar.classList.replace('bg-gray-600', 'bg-indigo-500');
                    card.classList.add('speaking');
                } else {
                    bar.classList.replace('bg-indigo-500', 'bg-gray-600');
                    card.classList.remove('speaking');
                }
                requestAnimationFrame(update);
            }
            update();
        }

        // --- Settings/Controls ---
        function toggleMute() {
            isMuted = !isMuted;
            localStream.getAudioTracks()[0].enabled = !isMuted;
            document.getElementById('mute-btn').innerText = isMuted ? 'Muted' : 'Mic';
            document.getElementById('mute-btn').classList.toggle('bg-rose-500');
        }

        function toggleSettings() {
            document.getElementById('settings-modal').classList.toggle('hidden');
        }

        function updateInputMode() {
            inputMode = document.getElementById('input-mode').value;
            document.getElementById('ptt-config').classList.toggle('hidden', inputMode !== 'ptt');
            if (localStream) {
                localStream.getAudioTracks()[0].enabled = (inputMode === 'open' && !isMuted);
            }
        }

        function rebindKey() {
            const btn = event.target;
            btn.innerText = "Listening...";
            const listener = (e) => {
                pttKey = e.code;
                document.getElementById('current-key').innerText = pttKey;
                btn.innerText = "Press to Rebind";
                window.removeEventListener('keydown', listener);
            };
            window.addEventListener('keydown', listener);
        }

        function copyRoomId() {
            const text = document.getElementById('room-id-text').innerText;
            navigator.clipboard.writeText(text);
            const btn = document.querySelector('#room-display button');
            const original = btn.innerHTML;
            btn.innerHTML = '<span class="text-emerald-400">Copied!</span>';
            setTimeout(() => btn.innerHTML = original, 2000);
        }

        function updateVolumeIndicator(id, active) {
            const card = document.getElementById(`peer-${id}`);
            if (active) card.classList.add('speaking');
            else card.classList.remove('speaking');
        }

    </script>
</body>
</html>

